; generated by Component: ARM Compiler 5.06 update 4 (build 422) Tool: ArmCC [4d3604]
; commandline ArmCC [--c99 --list --split_sections --debug -c --asm --interleave -o.\flash\obj\dhcp.o --asm_dir=.\Flash\List\ --list_dir=.\Flash\List\ --depend=.\flash\obj\dhcp.d --cpu=Cortex-M3 --apcs=interwork -O0 --diag_suppress=9931,870 -I..\..\Libraries\CMSIS\Device\ST\STM32F10x\Include -I..\..\Libraries\STM32F10x_StdPeriph_Driver\inc -I..\..\User\bsp -I..\..\User\bsp\inc -I..\..\User -I..\..\Libraries\CMSIS\Include -I..\..\FreeRTOS\include -I..\..\FreeRTOS\portable\RVDS\ARM_CM3 -I..\..\MQTT -I..\..\Ethernet -I..\..\Ethernet\W5500 -I..\..\Internet\DHCP -I..\..\Internet\DNS -I..\..\User\app\src -I..\..\User\app\inc -I..\..\Internet\NTP -I..\..\Internet\HTTP -I.\RTE\_Flash -ID:\MDK5\ARM\CMSIS\5.0.1\CMSIS\Include -ID:\MDK5\Keil\STM32F1xx_DFP\2.0.0\Device\Include -D__MICROLIB -D__UVISION_VERSION=523 -D_RTE_ -DSTM32F10X_HD -DUSE_STDPERIPH_DRIVER -DSTM32F10X_HD --omf_browse=.\flash\obj\dhcp.crf ..\..\Internet\DHCP\dhcp.c]
                          THUMB

                          AREA ||i.DHCP_init||, CODE, READONLY, ALIGN=2

                  DHCP_init PROC
;;;893    
;;;894    void DHCP_init(uint8_t s, uint8_t * buf)
000000  b538              PUSH     {r3-r5,lr}
;;;895    {
000002  4604              MOV      r4,r0
000004  460d              MOV      r5,r1
;;;896       uint8_t zeroip[4] = {0,0,0,0};
000006  2000              MOVS     r0,#0
000008  9000              STR      r0,[sp,#0]
;;;897       getSHAR(DHCP_CHADDR);
00000a  2206              MOVS     r2,#6
00000c  4922              LDR      r1,|L1.152|
00000e  f44f6010          MOV      r0,#0x900
000012  f7fffffe          BL       WIZCHIP_READ_BUF
;;;898       if((DHCP_CHADDR[0] | DHCP_CHADDR[1]  | DHCP_CHADDR[2] | DHCP_CHADDR[3] | DHCP_CHADDR[4] | DHCP_CHADDR[5]) == 0x00)
000016  4820              LDR      r0,|L1.152|
000018  7800              LDRB     r0,[r0,#0]  ; DHCP_CHADDR
00001a  491f              LDR      r1,|L1.152|
00001c  7849              LDRB     r1,[r1,#1]  ; DHCP_CHADDR
00001e  4308              ORRS     r0,r0,r1
000020  491d              LDR      r1,|L1.152|
000022  7889              LDRB     r1,[r1,#2]  ; DHCP_CHADDR
000024  4308              ORRS     r0,r0,r1
000026  491c              LDR      r1,|L1.152|
000028  78c9              LDRB     r1,[r1,#3]  ; DHCP_CHADDR
00002a  4308              ORRS     r0,r0,r1
00002c  491a              LDR      r1,|L1.152|
00002e  7909              LDRB     r1,[r1,#4]  ; DHCP_CHADDR
000030  4308              ORRS     r0,r0,r1
000032  4919              LDR      r1,|L1.152|
000034  7949              LDRB     r1,[r1,#5]  ; DHCP_CHADDR
000036  4308              ORRS     r0,r0,r1
000038  b978              CBNZ     r0,|L1.90|
;;;899       {
;;;900          // assing temporary mac address, you should be set SHAR before call this function. 
;;;901          DHCP_CHADDR[0] = 0x00;
00003a  2000              MOVS     r0,#0
00003c  4916              LDR      r1,|L1.152|
00003e  7008              STRB     r0,[r1,#0]
;;;902          DHCP_CHADDR[1] = 0x08;
000040  2008              MOVS     r0,#8
000042  7048              STRB     r0,[r1,#1]
;;;903          DHCP_CHADDR[2] = 0xdc;      
000044  20dc              MOVS     r0,#0xdc
000046  7088              STRB     r0,[r1,#2]
;;;904          DHCP_CHADDR[3] = 0x00;
000048  2000              MOVS     r0,#0
00004a  70c8              STRB     r0,[r1,#3]
;;;905          DHCP_CHADDR[4] = 0x00;
00004c  7108              STRB     r0,[r1,#4]
;;;906          DHCP_CHADDR[5] = 0x00; 
00004e  7148              STRB     r0,[r1,#5]
;;;907          setSHAR(DHCP_CHADDR);     
000050  2206              MOVS     r2,#6
000052  f44f6010          MOV      r0,#0x900
000056  f7fffffe          BL       WIZCHIP_WRITE_BUF
                  |L1.90|
;;;908       }
;;;909    
;;;910    	DHCP_SOCKET = s; // SOCK_DHCP
00005a  4810              LDR      r0,|L1.156|
00005c  7004              STRB     r4,[r0,#0]
;;;911    	pDHCPMSG = (RIP_MSG*)buf;
00005e  4810              LDR      r0,|L1.160|
000060  6005              STR      r5,[r0,#0]  ; pDHCPMSG
;;;912    	DHCP_XID = 0x12345678;
000062  4810              LDR      r0,|L1.164|
000064  4910              LDR      r1,|L1.168|
000066  6008              STR      r0,[r1,#0]  ; DHCP_XID
;;;913    
;;;914    	// WIZchip Netinfo Clear
;;;915    	setSIPR(zeroip);
000068  2204              MOVS     r2,#4
00006a  4669              MOV      r1,sp
00006c  f44f6070          MOV      r0,#0xf00
000070  f7fffffe          BL       WIZCHIP_WRITE_BUF
;;;916    	setSIPR(zeroip);
000074  2204              MOVS     r2,#4
000076  4669              MOV      r1,sp
000078  f44f6070          MOV      r0,#0xf00
00007c  f7fffffe          BL       WIZCHIP_WRITE_BUF
;;;917    	setGAR(zeroip);
000080  2204              MOVS     r2,#4
000082  4669              MOV      r1,sp
000084  0190              LSLS     r0,r2,#6
000086  f7fffffe          BL       WIZCHIP_WRITE_BUF
;;;918    
;;;919    	reset_DHCP_timeout();
00008a  f7fffffe          BL       reset_DHCP_timeout
;;;920    	dhcp_state = STATE_DHCP_INIT;
00008e  2000              MOVS     r0,#0
000090  4906              LDR      r1,|L1.172|
000092  7008              STRB     r0,[r1,#0]
;;;921    }
000094  bd38              POP      {r3-r5,pc}
;;;922    
                          ENDP

000096  0000              DCW      0x0000
                  |L1.152|
                          DCD      DHCP_CHADDR
                  |L1.156|
                          DCD      DHCP_SOCKET
                  |L1.160|
                          DCD      pDHCPMSG
                  |L1.164|
                          DCD      0x12345678
                  |L1.168|
                          DCD      DHCP_XID
                  |L1.172|
                          DCD      dhcp_state

                          AREA ||i.DHCP_run||, CODE, READONLY, ALIGN=2

                  DHCP_run PROC
;;;669    
;;;670    uint8_t DHCP_run(void)
000000  b570              PUSH     {r4-r6,lr}
;;;671    {
;;;672    	uint8_t  type;
;;;673    	uint8_t  ret;
;;;674    
;;;675    	if(dhcp_state == STATE_DHCP_STOP) return DHCP_STOPPED;
000002  4875              LDR      r0,|L2.472|
000004  7800              LDRB     r0,[r0,#0]  ; dhcp_state
000006  2806              CMP      r0,#6
000008  d101              BNE      |L2.14|
00000a  2005              MOVS     r0,#5
                  |L2.12|
;;;676    
;;;677    	if(getSn_SR(DHCP_SOCKET) != SOCK_UDP)
;;;678    	   socket(DHCP_SOCKET, Sn_MR_UDP, DHCP_CLIENT_PORT, 0x00);
;;;679    
;;;680    	ret = DHCP_RUNNING;
;;;681    	type = parseDHCPMSG();
;;;682    
;;;683    	switch ( dhcp_state ) {
;;;684    	   case STATE_DHCP_INIT     :
;;;685             DHCP_allocated_ip[0] = 0;
;;;686             DHCP_allocated_ip[1] = 0;
;;;687             DHCP_allocated_ip[2] = 0;
;;;688             DHCP_allocated_ip[3] = 0;
;;;689       		send_DHCP_DISCOVER();
;;;690       		dhcp_state = STATE_DHCP_DISCOVER;
;;;691       		break;
;;;692    		case STATE_DHCP_DISCOVER :
;;;693    			if (type == DHCP_OFFER){
;;;694    #ifdef _DHCP_DEBUG_
;;;695    				printf("> Receive DHCP_OFFER\r\n");
;;;696    #endif
;;;697                DHCP_allocated_ip[0] = pDHCPMSG->yiaddr[0];
;;;698                DHCP_allocated_ip[1] = pDHCPMSG->yiaddr[1];
;;;699                DHCP_allocated_ip[2] = pDHCPMSG->yiaddr[2];
;;;700                DHCP_allocated_ip[3] = pDHCPMSG->yiaddr[3];
;;;701    
;;;702    				send_DHCP_REQUEST();
;;;703    				dhcp_state = STATE_DHCP_REQUEST;
;;;704    			} else ret = check_DHCP_timeout();
;;;705             break;
;;;706    
;;;707    		case STATE_DHCP_REQUEST :
;;;708    			if (type == DHCP_ACK) {
;;;709    
;;;710    #ifdef _DHCP_DEBUG_
;;;711    				printf("> Receive DHCP_ACK\r\n");
;;;712    #endif
;;;713    				if (check_DHCP_leasedIP()) {
;;;714    					// Network info assignment from DHCP
;;;715    					dhcp_ip_assign();
;;;716    					reset_DHCP_timeout();
;;;717    
;;;718    					dhcp_state = STATE_DHCP_LEASED;
;;;719    				} else {
;;;720    					// IP address conflict occurred
;;;721    					reset_DHCP_timeout();
;;;722    					dhcp_ip_conflict();
;;;723    				    dhcp_state = STATE_DHCP_INIT;
;;;724    				}
;;;725    			} else if (type == DHCP_NAK) {
;;;726    
;;;727    #ifdef _DHCP_DEBUG_
;;;728    				printf("> Receive DHCP_NACK\r\n");
;;;729    #endif
;;;730    
;;;731    				reset_DHCP_timeout();
;;;732    
;;;733    				dhcp_state = STATE_DHCP_DISCOVER;
;;;734    			} else ret = check_DHCP_timeout();
;;;735    		break;
;;;736    
;;;737    		case STATE_DHCP_LEASED :
;;;738    		   ret = DHCP_IP_LEASED;
;;;739    			if ((dhcp_lease_time != INFINITE_LEASETIME) && ((dhcp_lease_time/2) < dhcp_tick_1s)) {
;;;740    				
;;;741    #ifdef _DHCP_DEBUG_
;;;742     				printf("> Maintains the IP address \r\n");
;;;743    #endif
;;;744    
;;;745    				type = 0;
;;;746    				OLD_allocated_ip[0] = DHCP_allocated_ip[0];
;;;747    				OLD_allocated_ip[1] = DHCP_allocated_ip[1];
;;;748    				OLD_allocated_ip[2] = DHCP_allocated_ip[2];
;;;749    				OLD_allocated_ip[3] = DHCP_allocated_ip[3];
;;;750    				
;;;751    				DHCP_XID++;
;;;752    
;;;753    				send_DHCP_REQUEST();
;;;754    
;;;755    				reset_DHCP_timeout();
;;;756    
;;;757    				dhcp_state = STATE_DHCP_REREQUEST;
;;;758    			}
;;;759    		break;
;;;760    
;;;761    		case STATE_DHCP_REREQUEST :
;;;762    		   ret = DHCP_IP_LEASED;
;;;763    			if (type == DHCP_ACK) {
;;;764    				dhcp_retry_count = 0;
;;;765    				if (OLD_allocated_ip[0] != DHCP_allocated_ip[0] || 
;;;766    				    OLD_allocated_ip[1] != DHCP_allocated_ip[1] ||
;;;767    				    OLD_allocated_ip[2] != DHCP_allocated_ip[2] ||
;;;768    				    OLD_allocated_ip[3] != DHCP_allocated_ip[3]) 
;;;769    				{
;;;770    					ret = DHCP_IP_CHANGED;
;;;771    					dhcp_ip_update();
;;;772                   #ifdef _DHCP_DEBUG_
;;;773                      printf(">IP changed.\r\n");
;;;774                   #endif
;;;775    					
;;;776    				}
;;;777             #ifdef _DHCP_DEBUG_
;;;778                else printf(">IP is continued.\r\n");
;;;779             #endif            				
;;;780    				reset_DHCP_timeout();
;;;781    				dhcp_state = STATE_DHCP_LEASED;
;;;782    			} else if (type == DHCP_NAK) {
;;;783    
;;;784    #ifdef _DHCP_DEBUG_
;;;785    				printf("> Receive DHCP_NACK, Failed to maintain ip\r\n");
;;;786    #endif
;;;787    
;;;788    				reset_DHCP_timeout();
;;;789    
;;;790    				dhcp_state = STATE_DHCP_DISCOVER;
;;;791    			} else ret = check_DHCP_timeout();
;;;792    	   	break;
;;;793    		default :
;;;794       		break;
;;;795    	}
;;;796    
;;;797    	return ret;
;;;798    }
00000c  bd70              POP      {r4-r6,pc}
                  |L2.14|
00000e  4973              LDR      r1,|L2.476|
000010  7809              LDRB     r1,[r1,#0]            ;677  ; DHCP_SOCKET
000012  0089              LSLS     r1,r1,#2              ;677
000014  1c49              ADDS     r1,r1,#1              ;677
000016  f44f7240          MOV      r2,#0x300             ;677
00001a  eb0200c1          ADD      r0,r2,r1,LSL #3       ;677
00001e  f7fffffe          BL       WIZCHIP_READ
000022  2822              CMP      r0,#0x22              ;677
000024  d006              BEQ      |L2.52|
000026  2300              MOVS     r3,#0                 ;678
000028  2244              MOVS     r2,#0x44              ;678
00002a  2102              MOVS     r1,#2                 ;678
00002c  486b              LDR      r0,|L2.476|
00002e  7800              LDRB     r0,[r0,#0]            ;678  ; DHCP_SOCKET
000030  f7fffffe          BL       socket
                  |L2.52|
000034  2501              MOVS     r5,#1                 ;680
000036  f7fffffe          BL       parseDHCPMSG
00003a  b2c4              UXTB     r4,r0                 ;681
00003c  4866              LDR      r0,|L2.472|
00003e  f9900000          LDRSB    r0,[r0,#0]            ;683  ; dhcp_state
000042  2805              CMP      r0,#5                 ;683
000044  d27e              BCS      |L2.324|
000046  e8dff000          TBB      [pc,r0]               ;683
00004a  030f              DCB      0x03,0x0f
00004c  2f588400          DCB      0x2f,0x58,0x84,0x00
000050  2000              MOVS     r0,#0                 ;685
000052  4963              LDR      r1,|L2.480|
000054  7008              STRB     r0,[r1,#0]            ;685
000056  7048              STRB     r0,[r1,#1]            ;686
000058  7088              STRB     r0,[r1,#2]            ;687
00005a  70c8              STRB     r0,[r1,#3]            ;688
00005c  f7fffffe          BL       send_DHCP_DISCOVER
000060  2001              MOVS     r0,#1                 ;690
000062  495d              LDR      r1,|L2.472|
000064  7008              STRB     r0,[r1,#0]            ;690
000066  e0b3              B        |L2.464|
000068  2c02              CMP      r4,#2                 ;693
00006a  d119              BNE      |L2.160|
00006c  a05d              ADR      r0,|L2.484|
00006e  f7fffffe          BL       __2printf
000072  4862              LDR      r0,|L2.508|
000074  6800              LDR      r0,[r0,#0]            ;697  ; pDHCPMSG
000076  7c00              LDRB     r0,[r0,#0x10]         ;697
000078  4959              LDR      r1,|L2.480|
00007a  7008              STRB     r0,[r1,#0]            ;697
00007c  485f              LDR      r0,|L2.508|
00007e  6800              LDR      r0,[r0,#0]            ;698  ; pDHCPMSG
000080  7c40              LDRB     r0,[r0,#0x11]         ;698
000082  7048              STRB     r0,[r1,#1]            ;698
000084  485d              LDR      r0,|L2.508|
000086  6800              LDR      r0,[r0,#0]            ;699  ; pDHCPMSG
000088  7c80              LDRB     r0,[r0,#0x12]         ;699
00008a  7088              STRB     r0,[r1,#2]            ;699
00008c  485b              LDR      r0,|L2.508|
00008e  6800              LDR      r0,[r0,#0]            ;700  ; pDHCPMSG
000090  7cc0              LDRB     r0,[r0,#0x13]         ;700
000092  70c8              STRB     r0,[r1,#3]            ;700
000094  f7fffffe          BL       send_DHCP_REQUEST
000098  2002              MOVS     r0,#2                 ;703
00009a  494f              LDR      r1,|L2.472|
00009c  7008              STRB     r0,[r1,#0]            ;703
00009e  e002              B        |L2.166|
                  |L2.160|
0000a0  f7fffffe          BL       check_DHCP_timeout
0000a4  4605              MOV      r5,r0                 ;704
                  |L2.166|
0000a6  e093              B        |L2.464|
0000a8  2c05              CMP      r4,#5                 ;708
0000aa  d117              BNE      |L2.220|
0000ac  a054              ADR      r0,|L2.512|
0000ae  f7fffffe          BL       __2printf
0000b2  f7fffffe          BL       check_DHCP_leasedIP
0000b6  b140              CBZ      r0,|L2.202|
0000b8  4857              LDR      r0,|L2.536|
0000ba  6800              LDR      r0,[r0,#0]            ;715  ; dhcp_ip_assign
0000bc  4780              BLX      r0                    ;715
0000be  f7fffffe          BL       reset_DHCP_timeout
0000c2  2003              MOVS     r0,#3                 ;718
0000c4  4944              LDR      r1,|L2.472|
0000c6  7008              STRB     r0,[r1,#0]            ;718
0000c8  e016              B        |L2.248|
                  |L2.202|
0000ca  f7fffffe          BL       reset_DHCP_timeout
0000ce  4853              LDR      r0,|L2.540|
0000d0  6800              LDR      r0,[r0,#0]            ;722  ; dhcp_ip_conflict
0000d2  4780              BLX      r0                    ;722
0000d4  2000              MOVS     r0,#0                 ;723
0000d6  4940              LDR      r1,|L2.472|
0000d8  7008              STRB     r0,[r1,#0]            ;723
0000da  e00d              B        |L2.248|
                  |L2.220|
0000dc  2c06              CMP      r4,#6                 ;725
0000de  d108              BNE      |L2.242|
0000e0  a04f              ADR      r0,|L2.544|
0000e2  f7fffffe          BL       __2printf
0000e6  f7fffffe          BL       reset_DHCP_timeout
0000ea  2001              MOVS     r0,#1                 ;733
0000ec  493a              LDR      r1,|L2.472|
0000ee  7008              STRB     r0,[r1,#0]            ;733
0000f0  e002              B        |L2.248|
                  |L2.242|
0000f2  f7fffffe          BL       check_DHCP_timeout
0000f6  4605              MOV      r5,r0                 ;734
                  |L2.248|
0000f8  e06a              B        |L2.464|
0000fa  2504              MOVS     r5,#4                 ;738
0000fc  484e              LDR      r0,|L2.568|
0000fe  6800              LDR      r0,[r0,#0]            ;739  ; dhcp_lease_time
000100  1c40              ADDS     r0,r0,#1              ;739
000102  b328              CBZ      r0,|L2.336|
000104  484d              LDR      r0,|L2.572|
000106  6800              LDR      r0,[r0,#0]            ;739  ; dhcp_tick_1s
000108  494b              LDR      r1,|L2.568|
00010a  6809              LDR      r1,[r1,#0]            ;739  ; dhcp_lease_time
00010c  ebb00f51          CMP      r0,r1,LSR #1          ;739
000110  d91e              BLS      |L2.336|
000112  a04b              ADR      r0,|L2.576|
000114  f7fffffe          BL       __2printf
000118  2400              MOVS     r4,#0                 ;745
00011a  4831              LDR      r0,|L2.480|
00011c  7800              LDRB     r0,[r0,#0]            ;746  ; DHCP_allocated_ip
00011e  4950              LDR      r1,|L2.608|
000120  7008              STRB     r0,[r1,#0]            ;746
000122  482f              LDR      r0,|L2.480|
000124  7840              LDRB     r0,[r0,#1]            ;747  ; DHCP_allocated_ip
000126  7048              STRB     r0,[r1,#1]            ;747
000128  482d              LDR      r0,|L2.480|
00012a  7880              LDRB     r0,[r0,#2]            ;748  ; DHCP_allocated_ip
00012c  7088              STRB     r0,[r1,#2]            ;748
00012e  482c              LDR      r0,|L2.480|
000130  78c0              LDRB     r0,[r0,#3]            ;749  ; DHCP_allocated_ip
000132  70c8              STRB     r0,[r1,#3]            ;749
000134  484b              LDR      r0,|L2.612|
000136  6800              LDR      r0,[r0,#0]            ;751  ; DHCP_XID
000138  1c40              ADDS     r0,r0,#1              ;751
00013a  494a              LDR      r1,|L2.612|
00013c  6008              STR      r0,[r1,#0]            ;751  ; DHCP_XID
00013e  f7fffffe          BL       send_DHCP_REQUEST
000142  e000              B        |L2.326|
                  |L2.324|
000144  e043              B        |L2.462|
                  |L2.326|
000146  f7fffffe          BL       reset_DHCP_timeout
00014a  2004              MOVS     r0,#4                 ;757
00014c  4922              LDR      r1,|L2.472|
00014e  7008              STRB     r0,[r1,#0]            ;757
                  |L2.336|
000150  e03e              B        |L2.464|
000152  2504              MOVS     r5,#4                 ;762
000154  2c05              CMP      r4,#5                 ;763
000156  d12b              BNE      |L2.432|
000158  2000              MOVS     r0,#0                 ;764
00015a  4943              LDR      r1,|L2.616|
00015c  7008              STRB     r0,[r1,#0]            ;764
00015e  4840              LDR      r0,|L2.608|
000160  7800              LDRB     r0,[r0,#0]            ;765  ; OLD_allocated_ip
000162  491f              LDR      r1,|L2.480|
000164  7809              LDRB     r1,[r1,#0]            ;765  ; DHCP_allocated_ip
000166  4288              CMP      r0,r1                 ;765
000168  d111              BNE      |L2.398|
00016a  483d              LDR      r0,|L2.608|
00016c  7840              LDRB     r0,[r0,#1]            ;766  ; OLD_allocated_ip
00016e  491c              LDR      r1,|L2.480|
000170  7849              LDRB     r1,[r1,#1]            ;766  ; DHCP_allocated_ip
000172  4288              CMP      r0,r1                 ;766
000174  d10b              BNE      |L2.398|
000176  483a              LDR      r0,|L2.608|
000178  7880              LDRB     r0,[r0,#2]            ;767  ; OLD_allocated_ip
00017a  4919              LDR      r1,|L2.480|
00017c  7889              LDRB     r1,[r1,#2]            ;767  ; DHCP_allocated_ip
00017e  4288              CMP      r0,r1                 ;767
000180  d105              BNE      |L2.398|
000182  4837              LDR      r0,|L2.608|
000184  78c0              LDRB     r0,[r0,#3]            ;768  ; OLD_allocated_ip
000186  4916              LDR      r1,|L2.480|
000188  78c9              LDRB     r1,[r1,#3]            ;768  ; DHCP_allocated_ip
00018a  4288              CMP      r0,r1                 ;768
00018c  d007              BEQ      |L2.414|
                  |L2.398|
00018e  2503              MOVS     r5,#3                 ;770
000190  4836              LDR      r0,|L2.620|
000192  6800              LDR      r0,[r0,#0]            ;771  ; dhcp_ip_update
000194  4780              BLX      r0                    ;771
000196  a036              ADR      r0,|L2.624|
000198  f7fffffe          BL       __2printf
00019c  e002              B        |L2.420|
                  |L2.414|
00019e  a038              ADR      r0,|L2.640|
0001a0  f7fffffe          BL       __2printf
                  |L2.420|
0001a4  f7fffffe          BL       reset_DHCP_timeout
0001a8  2003              MOVS     r0,#3                 ;781
0001aa  490b              LDR      r1,|L2.472|
0001ac  7008              STRB     r0,[r1,#0]            ;781
0001ae  e00d              B        |L2.460|
                  |L2.432|
0001b0  2c06              CMP      r4,#6                 ;782
0001b2  d108              BNE      |L2.454|
0001b4  a037              ADR      r0,|L2.660|
0001b6  f7fffffe          BL       __2printf
0001ba  f7fffffe          BL       reset_DHCP_timeout
0001be  2001              MOVS     r0,#1                 ;790
0001c0  4905              LDR      r1,|L2.472|
0001c2  7008              STRB     r0,[r1,#0]            ;790
0001c4  e002              B        |L2.460|
                  |L2.454|
0001c6  f7fffffe          BL       check_DHCP_timeout
0001ca  4605              MOV      r5,r0                 ;791
                  |L2.460|
0001cc  e000              B        |L2.464|
                  |L2.462|
0001ce  bf00              NOP                            ;794
                  |L2.464|
0001d0  bf00              NOP                            ;691
0001d2  4628              MOV      r0,r5                 ;797
0001d4  e71a              B        |L2.12|
;;;799    
                          ENDP

0001d6  0000              DCW      0x0000
                  |L2.472|
                          DCD      dhcp_state
                  |L2.476|
                          DCD      DHCP_SOCKET
                  |L2.480|
                          DCD      DHCP_allocated_ip
                  |L2.484|
0001e4  3e205265          DCB      "> Receive DHCP_OFFER\r\n",0
0001e8  63656976
0001ec  65204448
0001f0  43505f4f
0001f4  46464552
0001f8  0d0a00  
0001fb  00                DCB      0
                  |L2.508|
                          DCD      pDHCPMSG
                  |L2.512|
000200  3e205265          DCB      "> Receive DHCP_ACK\r\n",0
000204  63656976
000208  65204448
00020c  43505f41
000210  434b0d0a
000214  00      
000215  00                DCB      0
000216  00                DCB      0
000217  00                DCB      0
                  |L2.536|
                          DCD      dhcp_ip_assign
                  |L2.540|
                          DCD      dhcp_ip_conflict
                  |L2.544|
000220  3e205265          DCB      "> Receive DHCP_NACK\r\n",0
000224  63656976
000228  65204448
00022c  43505f4e
000230  41434b0d
000234  0a00    
000236  00                DCB      0
000237  00                DCB      0
                  |L2.568|
                          DCD      dhcp_lease_time
                  |L2.572|
                          DCD      dhcp_tick_1s
                  |L2.576|
000240  3e204d61          DCB      "> Maintains the IP address \r\n",0
000244  696e7461
000248  696e7320
00024c  74686520
000250  49502061
000254  64647265
000258  7373200d
00025c  0a00    
00025e  00                DCB      0
00025f  00                DCB      0
                  |L2.608|
                          DCD      OLD_allocated_ip
                  |L2.612|
                          DCD      DHCP_XID
                  |L2.616|
                          DCD      dhcp_retry_count
                  |L2.620|
                          DCD      dhcp_ip_update
                  |L2.624|
000270  3e495020          DCB      ">IP changed.\r\n",0
000274  6368616e
000278  6765642e
00027c  0d0a00  
00027f  00                DCB      0
                  |L2.640|
000280  3e495020          DCB      ">IP is continued.\r\n",0
000284  69732063
000288  6f6e7469
00028c  6e756564
000290  2e0d0a00
                  |L2.660|
000294  3e205265          DCB      "> Receive DHCP_NACK, Failed to maintain ip\r\n",0
000298  63656976
00029c  65204448
0002a0  43505f4e
0002a4  41434b2c
0002a8  20466169
0002ac  6c656420
0002b0  746f206d
0002b4  61696e74
0002b8  61696e20
0002bc  69700d0a
0002c0  00      
0002c1  00                DCB      0
0002c2  00                DCB      0
0002c3  00                DCB      0

                          AREA ||i.DHCP_stop||, CODE, READONLY, ALIGN=2

                  DHCP_stop PROC
;;;799    
;;;800    void    DHCP_stop(void)
000000  b510              PUSH     {r4,lr}
;;;801    {
;;;802       close(DHCP_SOCKET);
000002  4804              LDR      r0,|L3.20|
000004  7800              LDRB     r0,[r0,#0]  ; DHCP_SOCKET
000006  f7fffffe          BL       close
;;;803       dhcp_state = STATE_DHCP_STOP;
00000a  2006              MOVS     r0,#6
00000c  4902              LDR      r1,|L3.24|
00000e  7008              STRB     r0,[r1,#0]
;;;804    }
000010  bd10              POP      {r4,pc}
;;;805    
                          ENDP

000012  0000              DCW      0x0000
                  |L3.20|
                          DCD      DHCP_SOCKET
                  |L3.24|
                          DCD      dhcp_state

                          AREA ||i.DHCP_time_handler||, CODE, READONLY, ALIGN=2

                  DHCP_time_handler PROC
;;;931    
;;;932    void DHCP_time_handler(void)
000000  4802              LDR      r0,|L4.12|
;;;933    {
;;;934    	dhcp_tick_1s++;
000002  6800              LDR      r0,[r0,#0]  ; dhcp_tick_1s
000004  1c40              ADDS     r0,r0,#1
000006  4901              LDR      r1,|L4.12|
000008  6008              STR      r0,[r1,#0]  ; dhcp_tick_1s
;;;935    }
00000a  4770              BX       lr
;;;936    
                          ENDP

                  |L4.12|
                          DCD      dhcp_tick_1s

                          AREA ||i.check_DHCP_leasedIP||, CODE, READONLY, ALIGN=2

                  check_DHCP_leasedIP PROC
;;;858    
;;;859    int8_t check_DHCP_leasedIP(void)
000000  b538              PUSH     {r3-r5,lr}
;;;860    {
;;;861    	uint8_t tmp;
;;;862    	int32_t ret;
;;;863    
;;;864    	//WIZchip RCR value changed for ARP Timeout count control
;;;865    	tmp = getRCR();
000002  f44f50d8          MOV      r0,#0x1b00
000006  f7fffffe          BL       WIZCHIP_READ
00000a  4605              MOV      r5,r0
;;;866    	setRCR(0x03);
00000c  2103              MOVS     r1,#3
00000e  f44f50d8          MOV      r0,#0x1b00
000012  f7fffffe          BL       WIZCHIP_WRITE
;;;867    
;;;868    	// IP conflict detection : ARP request - ARP reply
;;;869    	// Broadcasting ARP Request for check the IP conflict using UDP sendto() function
;;;870    	ret = sendto(DHCP_SOCKET, (uint8_t *)"CHECK_IP_CONFLICT", 17, DHCP_allocated_ip, 5000);
000016  f2413088          MOV      r0,#0x1388
00001a  4b11              LDR      r3,|L5.96|
00001c  2211              MOVS     r2,#0x11
00001e  a111              ADR      r1,|L5.100|
000020  9000              STR      r0,[sp,#0]
000022  4815              LDR      r0,|L5.120|
000024  7800              LDRB     r0,[r0,#0]  ; DHCP_SOCKET
000026  f7fffffe          BL       sendto
00002a  4604              MOV      r4,r0
;;;871    
;;;872    	// RCR value restore
;;;873    	setRCR(tmp);
00002c  4629              MOV      r1,r5
00002e  f44f50d8          MOV      r0,#0x1b00
000032  f7fffffe          BL       WIZCHIP_WRITE
;;;874    
;;;875    	if(ret == SOCKERR_TIMEOUT) {
000036  f104000d          ADD      r0,r4,#0xd
00003a  b920              CBNZ     r0,|L5.70|
;;;876    		// UDP send Timeout occurred : allocated IP address is unique, DHCP Success
;;;877    
;;;878    #ifdef _DHCP_DEBUG_
;;;879    		printf("\r\n> Check leased IP - OK\r\n");
00003c  a00f              ADR      r0,|L5.124|
00003e  f7fffffe          BL       __2printf
;;;880    #endif
;;;881    
;;;882    		return 1;
000042  2001              MOVS     r0,#1
                  |L5.68|
;;;883    	} else {
;;;884    		// Received ARP reply or etc : IP address conflict occur, DHCP Failed
;;;885    		send_DHCP_DECLINE();
;;;886    
;;;887    		ret = dhcp_tick_1s;
;;;888    		while((dhcp_tick_1s - ret) < 2) ;   // wait for 1s over; wait to complete to send DECLINE message;
;;;889    
;;;890    		return 0;
;;;891    	}
;;;892    }	
000044  bd38              POP      {r3-r5,pc}
                  |L5.70|
000046  f7fffffe          BL       send_DHCP_DECLINE
00004a  4813              LDR      r0,|L5.152|
00004c  6804              LDR      r4,[r0,#0]            ;887  ; dhcp_tick_1s
00004e  bf00              NOP                            ;888
                  |L5.80|
000050  4811              LDR      r0,|L5.152|
000052  6800              LDR      r0,[r0,#0]            ;888  ; dhcp_tick_1s
000054  1b00              SUBS     r0,r0,r4              ;888
000056  2802              CMP      r0,#2                 ;888
000058  d3fa              BCC      |L5.80|
00005a  2000              MOVS     r0,#0                 ;890
00005c  e7f2              B        |L5.68|
;;;893    
                          ENDP

00005e  0000              DCW      0x0000
                  |L5.96|
                          DCD      DHCP_allocated_ip
                  |L5.100|
000064  43484543          DCB      "CHECK_IP_CONFLICT",0
000068  4b5f4950
00006c  5f434f4e
000070  464c4943
000074  5400    
000076  00                DCB      0
000077  00                DCB      0
                  |L5.120|
                          DCD      DHCP_SOCKET
                  |L5.124|
00007c  0d0a3e20          DCB      "\r\n> Check leased IP - OK\r\n",0
000080  43686563
000084  6b206c65
000088  61736564
00008c  20495020
000090  2d204f4b
000094  0d0a00  
000097  00                DCB      0
                  |L5.152|
                          DCD      dhcp_tick_1s

                          AREA ||i.check_DHCP_timeout||, CODE, READONLY, ALIGN=2

                  check_DHCP_timeout PROC
;;;805    
;;;806    uint8_t check_DHCP_timeout(void)
000000  b510              PUSH     {r4,lr}
;;;807    {
;;;808    	uint8_t ret = DHCP_RUNNING;
000002  2401              MOVS     r4,#1
;;;809    	
;;;810    	if (dhcp_retry_count < MAX_DHCP_RETRY) {
000004  481a              LDR      r0,|L6.112|
000006  f9900000          LDRSB    r0,[r0,#0]  ; dhcp_retry_count
00000a  2814              CMP      r0,#0x14
00000c  da14              BGE      |L6.56|
;;;811    		//if (dhcp_tick_next < dhcp_tick_1s) {
;;;812    
;;;813    			switch ( dhcp_state ) {
00000e  4819              LDR      r0,|L6.116|
000010  f9900000          LDRSB    r0,[r0,#0]  ; dhcp_state
000014  2801              CMP      r0,#1
000016  d004              BEQ      |L6.34|
000018  2802              CMP      r0,#2
00001a  d005              BEQ      |L6.40|
00001c  2804              CMP      r0,#4
00001e  d109              BNE      |L6.52|
000020  e005              B        |L6.46|
                  |L6.34|
;;;814    				case STATE_DHCP_DISCOVER :
;;;815    //					printf("<<timeout>> state : STATE_DHCP_DISCOVER\r\n");
;;;816    					send_DHCP_DISCOVER();
000022  f7fffffe          BL       send_DHCP_DISCOVER
;;;817    				break;
000026  e006              B        |L6.54|
                  |L6.40|
;;;818    		
;;;819    				case STATE_DHCP_REQUEST :
;;;820    //					printf("<<timeout>> state : STATE_DHCP_REQUEST\r\n");
;;;821    
;;;822    					send_DHCP_REQUEST();
000028  f7fffffe          BL       send_DHCP_REQUEST
;;;823    				break;
00002c  e003              B        |L6.54|
                  |L6.46|
;;;824    
;;;825    				case STATE_DHCP_REREQUEST :
;;;826    //					printf("<<timeout>> state : STATE_DHCP_REREQUEST\r\n");
;;;827    					
;;;828    					send_DHCP_REQUEST();
00002e  f7fffffe          BL       send_DHCP_REQUEST
;;;829    				break;
000032  e000              B        |L6.54|
                  |L6.52|
;;;830    		
;;;831    				default :
;;;832    				break;
000034  bf00              NOP      
                  |L6.54|
000036  e019              B        |L6.108|
                  |L6.56|
;;;833    	//		}
;;;834    
;;;835    			dhcp_tick_1s = 0;
;;;836    			dhcp_tick_next = dhcp_tick_1s + DHCP_WAIT_TIME;
;;;837    			dhcp_retry_count++;
;;;838    		}
;;;839    	} else { // timeout occurred
;;;840    
;;;841    		switch(dhcp_state) {
000038  480e              LDR      r0,|L6.116|
00003a  f9900000          LDRSB    r0,[r0,#0]  ; dhcp_state
00003e  2801              CMP      r0,#1
000040  d004              BEQ      |L6.76|
000042  2802              CMP      r0,#2
000044  d007              BEQ      |L6.86|
000046  2804              CMP      r0,#4
000048  d10c              BNE      |L6.100|
00004a  e005              B        |L6.88|
                  |L6.76|
;;;842    			case STATE_DHCP_DISCOVER:
;;;843    				dhcp_state = STATE_DHCP_INIT;
00004c  2000              MOVS     r0,#0
00004e  4909              LDR      r1,|L6.116|
000050  7008              STRB     r0,[r1,#0]
;;;844    				ret = DHCP_FAILED;
000052  2400              MOVS     r4,#0
;;;845    				break;
000054  e007              B        |L6.102|
                  |L6.86|
;;;846    			case STATE_DHCP_REQUEST:
;;;847    			case STATE_DHCP_REREQUEST:
000056  bf00              NOP      
                  |L6.88|
;;;848    				send_DHCP_DISCOVER();
000058  f7fffffe          BL       send_DHCP_DISCOVER
;;;849    				dhcp_state = STATE_DHCP_DISCOVER;
00005c  2001              MOVS     r0,#1
00005e  4905              LDR      r1,|L6.116|
000060  7008              STRB     r0,[r1,#0]
;;;850    				break;
000062  e000              B        |L6.102|
                  |L6.100|
;;;851    			default :
;;;852    				break;
000064  bf00              NOP      
                  |L6.102|
000066  bf00              NOP                            ;845
;;;853    		}
;;;854    		reset_DHCP_timeout();
000068  f7fffffe          BL       reset_DHCP_timeout
                  |L6.108|
;;;855    	}
;;;856    	return ret;
00006c  4620              MOV      r0,r4
;;;857    }
00006e  bd10              POP      {r4,pc}
;;;858    
                          ENDP

                  |L6.112|
                          DCD      dhcp_retry_count
                  |L6.116|
                          DCD      dhcp_state

                          AREA ||i.default_ip_assign||, CODE, READONLY, ALIGN=2

                  default_ip_assign PROC
;;;253    /* The default handler of ip assign first */
;;;254    void default_ip_assign(void)
000000  b510              PUSH     {r4,lr}
;;;255    {
;;;256       setSIPR(DHCP_allocated_ip);
000002  2204              MOVS     r2,#4
000004  4908              LDR      r1,|L7.40|
000006  f44f6070          MOV      r0,#0xf00
00000a  f7fffffe          BL       WIZCHIP_WRITE_BUF
;;;257       setSUBR(DHCP_allocated_sn);
00000e  2204              MOVS     r2,#4
000010  4906              LDR      r1,|L7.44|
000012  f44f60a0          MOV      r0,#0x500
000016  f7fffffe          BL       WIZCHIP_WRITE_BUF
;;;258       setGAR (DHCP_allocated_gw);
00001a  2204              MOVS     r2,#4
00001c  4904              LDR      r1,|L7.48|
00001e  0190              LSLS     r0,r2,#6
000020  f7fffffe          BL       WIZCHIP_WRITE_BUF
;;;259    }
000024  bd10              POP      {r4,pc}
;;;260    
                          ENDP

000026  0000              DCW      0x0000
                  |L7.40|
                          DCD      DHCP_allocated_ip
                  |L7.44|
                          DCD      DHCP_allocated_sn
                  |L7.48|
                          DCD      DHCP_allocated_gw

                          AREA ||i.default_ip_conflict||, CODE, READONLY, ALIGN=2

                  default_ip_conflict PROC
;;;271    /* The default handler of ip chaged */
;;;272    void default_ip_conflict(void)
000000  b510              PUSH     {r4,lr}
;;;273    {
;;;274    	// WIZchip Software Reset
;;;275    	setMR(MR_RST);
000002  2180              MOVS     r1,#0x80
000004  2000              MOVS     r0,#0
000006  f7fffffe          BL       WIZCHIP_WRITE
;;;276    	getMR(); // for delay
00000a  2000              MOVS     r0,#0
00000c  f7fffffe          BL       WIZCHIP_READ
;;;277    	setSHAR(DHCP_CHADDR);
000010  2206              MOVS     r2,#6
000012  4903              LDR      r1,|L8.32|
000014  f44f6010          MOV      r0,#0x900
000018  f7fffffe          BL       WIZCHIP_WRITE_BUF
;;;278    }
00001c  bd10              POP      {r4,pc}
;;;279    
                          ENDP

00001e  0000              DCW      0x0000
                  |L8.32|
                          DCD      DHCP_CHADDR

                          AREA ||i.default_ip_update||, CODE, READONLY, ALIGN=2

                  default_ip_update PROC
;;;261    /* The default handler of ip chaged */
;;;262    void default_ip_update(void)
000000  b510              PUSH     {r4,lr}
;;;263    {
;;;264    	/* WIZchip Software Reset */
;;;265       setMR(MR_RST);
000002  2180              MOVS     r1,#0x80
000004  2000              MOVS     r0,#0
000006  f7fffffe          BL       WIZCHIP_WRITE
;;;266       getMR(); // for delay
00000a  2000              MOVS     r0,#0
00000c  f7fffffe          BL       WIZCHIP_READ
;;;267       default_ip_assign();
000010  f7fffffe          BL       default_ip_assign
;;;268       setSHAR(DHCP_CHADDR);
000014  2206              MOVS     r2,#6
000016  4903              LDR      r1,|L9.36|
000018  f44f6010          MOV      r0,#0x900
00001c  f7fffffe          BL       WIZCHIP_WRITE_BUF
;;;269    }
000020  bd10              POP      {r4,pc}
;;;270    
                          ENDP

000022  0000              DCW      0x0000
                  |L9.36|
                          DCD      DHCP_CHADDR

                          AREA ||i.getDHCPLeasetime||, CODE, READONLY, ALIGN=2

                  getDHCPLeasetime PROC
;;;968    
;;;969    uint32_t getDHCPLeasetime(void)
000000  4801              LDR      r0,|L10.8|
;;;970    {
;;;971    	return dhcp_lease_time;
000002  6800              LDR      r0,[r0,#0]  ; dhcp_lease_time
;;;972    }
000004  4770              BX       lr
;;;973    
                          ENDP

000006  0000              DCW      0x0000
                  |L10.8|
                          DCD      dhcp_lease_time

                          AREA ||i.getDNSfromDHCP||, CODE, READONLY, ALIGN=2

                  getDNSfromDHCP PROC
;;;960    
;;;961    void getDNSfromDHCP(uint8_t* ip)
000000  4906              LDR      r1,|L11.28|
;;;962    {
;;;963       ip[0] = DHCP_allocated_dns[0];
000002  7809              LDRB     r1,[r1,#0]  ; DHCP_allocated_dns
000004  7001              STRB     r1,[r0,#0]
;;;964       ip[1] = DHCP_allocated_dns[1];
000006  4905              LDR      r1,|L11.28|
000008  7849              LDRB     r1,[r1,#1]  ; DHCP_allocated_dns
00000a  7041              STRB     r1,[r0,#1]
;;;965       ip[2] = DHCP_allocated_dns[2];
00000c  4903              LDR      r1,|L11.28|
00000e  7889              LDRB     r1,[r1,#2]  ; DHCP_allocated_dns
000010  7081              STRB     r1,[r0,#2]
;;;966       ip[3] = DHCP_allocated_dns[3];         
000012  4902              LDR      r1,|L11.28|
000014  78c9              LDRB     r1,[r1,#3]  ; DHCP_allocated_dns
000016  70c1              STRB     r1,[r0,#3]
;;;967    }
000018  4770              BX       lr
;;;968    
                          ENDP

00001a  0000              DCW      0x0000
                  |L11.28|
                          DCD      DHCP_allocated_dns

                          AREA ||i.getGWfromDHCP||, CODE, READONLY, ALIGN=2

                  getGWfromDHCP PROC
;;;944    
;;;945    void getGWfromDHCP(uint8_t* ip)
000000  4906              LDR      r1,|L12.28|
;;;946    {
;;;947    	ip[0] =DHCP_allocated_gw[0];
000002  7809              LDRB     r1,[r1,#0]  ; DHCP_allocated_gw
000004  7001              STRB     r1,[r0,#0]
;;;948    	ip[1] =DHCP_allocated_gw[1];
000006  4905              LDR      r1,|L12.28|
000008  7849              LDRB     r1,[r1,#1]  ; DHCP_allocated_gw
00000a  7041              STRB     r1,[r0,#1]
;;;949    	ip[2] =DHCP_allocated_gw[2];
00000c  4903              LDR      r1,|L12.28|
00000e  7889              LDRB     r1,[r1,#2]  ; DHCP_allocated_gw
000010  7081              STRB     r1,[r0,#2]
;;;950    	ip[3] =DHCP_allocated_gw[3];			
000012  4902              LDR      r1,|L12.28|
000014  78c9              LDRB     r1,[r1,#3]  ; DHCP_allocated_gw
000016  70c1              STRB     r1,[r0,#3]
;;;951    }
000018  4770              BX       lr
;;;952    
                          ENDP

00001a  0000              DCW      0x0000
                  |L12.28|
                          DCD      DHCP_allocated_gw

                          AREA ||i.getIPfromDHCP||, CODE, READONLY, ALIGN=2

                  getIPfromDHCP PROC
;;;936    
;;;937    void getIPfromDHCP(uint8_t* ip)
000000  4906              LDR      r1,|L13.28|
;;;938    {
;;;939    	ip[0] = DHCP_allocated_ip[0];
000002  7809              LDRB     r1,[r1,#0]  ; DHCP_allocated_ip
000004  7001              STRB     r1,[r0,#0]
;;;940    	ip[1] = DHCP_allocated_ip[1];
000006  4905              LDR      r1,|L13.28|
000008  7849              LDRB     r1,[r1,#1]  ; DHCP_allocated_ip
00000a  7041              STRB     r1,[r0,#1]
;;;941    	ip[2] = DHCP_allocated_ip[2];	
00000c  4903              LDR      r1,|L13.28|
00000e  7889              LDRB     r1,[r1,#2]  ; DHCP_allocated_ip
000010  7081              STRB     r1,[r0,#2]
;;;942    	ip[3] = DHCP_allocated_ip[3];
000012  4902              LDR      r1,|L13.28|
000014  78c9              LDRB     r1,[r1,#3]  ; DHCP_allocated_ip
000016  70c1              STRB     r1,[r0,#3]
;;;943    }
000018  4770              BX       lr
;;;944    
                          ENDP

00001a  0000              DCW      0x0000
                  |L13.28|
                          DCD      DHCP_allocated_ip

                          AREA ||i.getSNfromDHCP||, CODE, READONLY, ALIGN=2

                  getSNfromDHCP PROC
;;;952    
;;;953    void getSNfromDHCP(uint8_t* ip)
000000  4906              LDR      r1,|L14.28|
;;;954    {
;;;955       ip[0] = DHCP_allocated_sn[0];
000002  7809              LDRB     r1,[r1,#0]  ; DHCP_allocated_sn
000004  7001              STRB     r1,[r0,#0]
;;;956       ip[1] = DHCP_allocated_sn[1];
000006  4905              LDR      r1,|L14.28|
000008  7849              LDRB     r1,[r1,#1]  ; DHCP_allocated_sn
00000a  7041              STRB     r1,[r0,#1]
;;;957       ip[2] = DHCP_allocated_sn[2];
00000c  4903              LDR      r1,|L14.28|
00000e  7889              LDRB     r1,[r1,#2]  ; DHCP_allocated_sn
000010  7081              STRB     r1,[r0,#2]
;;;958       ip[3] = DHCP_allocated_sn[3];         
000012  4902              LDR      r1,|L14.28|
000014  78c9              LDRB     r1,[r1,#3]  ; DHCP_allocated_sn
000016  70c1              STRB     r1,[r0,#3]
;;;959    }
000018  4770              BX       lr
;;;960    
                          ENDP

00001a  0000              DCW      0x0000
                  |L14.28|
                          DCD      DHCP_allocated_sn

                          AREA ||i.makeDHCPMSG||, CODE, READONLY, ALIGN=2

                  makeDHCPMSG PROC
;;;291    /* make the common DHCP message */
;;;292    void makeDHCPMSG(void)
000000  b57c              PUSH     {r2-r6,lr}
;;;293    {
;;;294       uint8_t  bk_mac[6];
;;;295       uint8_t* ptmp;
;;;296       uint8_t  i;
;;;297       getSHAR(bk_mac);
000002  2206              MOVS     r2,#6
000004  4669              MOV      r1,sp
000006  f44f6010          MOV      r0,#0x900
00000a  f7fffffe          BL       WIZCHIP_READ_BUF
;;;298    	pDHCPMSG->op      = DHCP_BOOTREQUEST;
00000e  2001              MOVS     r0,#1
000010  495c              LDR      r1,|L15.388|
000012  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
000014  7008              STRB     r0,[r1,#0]
;;;299    	pDHCPMSG->htype   = DHCP_HTYPE10MB;
000016  495b              LDR      r1,|L15.388|
000018  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
00001a  7048              STRB     r0,[r1,#1]
;;;300    	pDHCPMSG->hlen    = DHCP_HLENETHERNET;
00001c  2006              MOVS     r0,#6
00001e  4959              LDR      r1,|L15.388|
000020  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
000022  7088              STRB     r0,[r1,#2]
;;;301    	pDHCPMSG->hops    = DHCP_HOPS;
000024  2000              MOVS     r0,#0
000026  4957              LDR      r1,|L15.388|
000028  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
00002a  70c8              STRB     r0,[r1,#3]
;;;302    	ptmp              = (uint8_t*)(&pDHCPMSG->xid);
00002c  4855              LDR      r0,|L15.388|
00002e  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
000030  1d05              ADDS     r5,r0,#4
;;;303    	*(ptmp+0)         = (uint8_t)((DHCP_XID & 0xFF000000) >> 24);
000032  4855              LDR      r0,|L15.392|
000034  6800              LDR      r0,[r0,#0]  ; DHCP_XID
000036  0e00              LSRS     r0,r0,#24
000038  7028              STRB     r0,[r5,#0]
;;;304    	*(ptmp+1)         = (uint8_t)((DHCP_XID & 0x00FF0000) >> 16);
00003a  4853              LDR      r0,|L15.392|
00003c  6800              LDR      r0,[r0,#0]  ; DHCP_XID
00003e  0c00              LSRS     r0,r0,#16
000040  7068              STRB     r0,[r5,#1]
;;;305       *(ptmp+2)         = (uint8_t)((DHCP_XID & 0x0000FF00) >>  8);
000042  4851              LDR      r0,|L15.392|
000044  8800              LDRH     r0,[r0,#0]  ; DHCP_XID
000046  0a00              LSRS     r0,r0,#8
000048  70a8              STRB     r0,[r5,#2]
;;;306    	*(ptmp+3)         = (uint8_t)((DHCP_XID & 0x000000FF) >>  0);   
00004a  484f              LDR      r0,|L15.392|
00004c  7800              LDRB     r0,[r0,#0]  ; DHCP_XID
00004e  70e8              STRB     r0,[r5,#3]
;;;307    	pDHCPMSG->secs    = DHCP_SECS;
000050  2000              MOVS     r0,#0
000052  494c              LDR      r1,|L15.388|
000054  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
000056  8108              STRH     r0,[r1,#8]
;;;308    	ptmp              = (uint8_t*)(&pDHCPMSG->flags);	
000058  484a              LDR      r0,|L15.388|
00005a  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
00005c  f100050a          ADD      r5,r0,#0xa
;;;309    	*(ptmp+0)         = (uint8_t)((DHCP_FLAGSBROADCAST & 0xFF00) >> 8);
000060  2080              MOVS     r0,#0x80
000062  7028              STRB     r0,[r5,#0]
;;;310    	*(ptmp+1)         = (uint8_t)((DHCP_FLAGSBROADCAST & 0x00FF) >> 0);
000064  2000              MOVS     r0,#0
000066  7068              STRB     r0,[r5,#1]
;;;311    
;;;312    	pDHCPMSG->ciaddr[0] = 0;
000068  4946              LDR      r1,|L15.388|
00006a  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
00006c  7308              STRB     r0,[r1,#0xc]
;;;313    	pDHCPMSG->ciaddr[1] = 0;
00006e  2100              MOVS     r1,#0
000070  4844              LDR      r0,|L15.388|
000072  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
000074  7341              STRB     r1,[r0,#0xd]
;;;314    	pDHCPMSG->ciaddr[2] = 0;
000076  4843              LDR      r0,|L15.388|
000078  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
00007a  7381              STRB     r1,[r0,#0xe]
;;;315    	pDHCPMSG->ciaddr[3] = 0;
00007c  4841              LDR      r0,|L15.388|
00007e  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
000080  73c1              STRB     r1,[r0,#0xf]
;;;316    
;;;317    	pDHCPMSG->yiaddr[0] = 0;
000082  2000              MOVS     r0,#0
000084  493f              LDR      r1,|L15.388|
000086  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
000088  7408              STRB     r0,[r1,#0x10]
;;;318    	pDHCPMSG->yiaddr[1] = 0;
00008a  2100              MOVS     r1,#0
00008c  483d              LDR      r0,|L15.388|
00008e  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
000090  7441              STRB     r1,[r0,#0x11]
;;;319    	pDHCPMSG->yiaddr[2] = 0;
000092  483c              LDR      r0,|L15.388|
000094  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
000096  7481              STRB     r1,[r0,#0x12]
;;;320    	pDHCPMSG->yiaddr[3] = 0;
000098  483a              LDR      r0,|L15.388|
00009a  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
00009c  74c1              STRB     r1,[r0,#0x13]
;;;321    
;;;322    	pDHCPMSG->siaddr[0] = 0;
00009e  2000              MOVS     r0,#0
0000a0  4938              LDR      r1,|L15.388|
0000a2  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
0000a4  7508              STRB     r0,[r1,#0x14]
;;;323    	pDHCPMSG->siaddr[1] = 0;
0000a6  2100              MOVS     r1,#0
0000a8  4836              LDR      r0,|L15.388|
0000aa  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
0000ac  7541              STRB     r1,[r0,#0x15]
;;;324    	pDHCPMSG->siaddr[2] = 0;
0000ae  4835              LDR      r0,|L15.388|
0000b0  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
0000b2  7581              STRB     r1,[r0,#0x16]
;;;325    	pDHCPMSG->siaddr[3] = 0;
0000b4  4833              LDR      r0,|L15.388|
0000b6  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
0000b8  75c1              STRB     r1,[r0,#0x17]
;;;326    
;;;327    	pDHCPMSG->giaddr[0] = 0;
0000ba  2000              MOVS     r0,#0
0000bc  4931              LDR      r1,|L15.388|
0000be  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
0000c0  7608              STRB     r0,[r1,#0x18]
;;;328    	pDHCPMSG->giaddr[1] = 0;
0000c2  2100              MOVS     r1,#0
0000c4  482f              LDR      r0,|L15.388|
0000c6  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
0000c8  7641              STRB     r1,[r0,#0x19]
;;;329    	pDHCPMSG->giaddr[2] = 0;
0000ca  482e              LDR      r0,|L15.388|
0000cc  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
0000ce  7681              STRB     r1,[r0,#0x1a]
;;;330    	pDHCPMSG->giaddr[3] = 0;
0000d0  482c              LDR      r0,|L15.388|
0000d2  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
0000d4  76c1              STRB     r1,[r0,#0x1b]
;;;331    
;;;332    	pDHCPMSG->chaddr[0] = DHCP_CHADDR[0];
0000d6  482d              LDR      r0,|L15.396|
0000d8  7800              LDRB     r0,[r0,#0]  ; DHCP_CHADDR
0000da  492a              LDR      r1,|L15.388|
0000dc  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
0000de  7708              STRB     r0,[r1,#0x1c]
;;;333    	pDHCPMSG->chaddr[1] = DHCP_CHADDR[1];
0000e0  482a              LDR      r0,|L15.396|
0000e2  7841              LDRB     r1,[r0,#1]  ; DHCP_CHADDR
0000e4  4827              LDR      r0,|L15.388|
0000e6  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
0000e8  7741              STRB     r1,[r0,#0x1d]
;;;334    	pDHCPMSG->chaddr[2] = DHCP_CHADDR[2];
0000ea  4828              LDR      r0,|L15.396|
0000ec  7881              LDRB     r1,[r0,#2]  ; DHCP_CHADDR
0000ee  4825              LDR      r0,|L15.388|
0000f0  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
0000f2  7781              STRB     r1,[r0,#0x1e]
;;;335    	pDHCPMSG->chaddr[3] = DHCP_CHADDR[3];
0000f4  4825              LDR      r0,|L15.396|
0000f6  78c1              LDRB     r1,[r0,#3]  ; DHCP_CHADDR
0000f8  4822              LDR      r0,|L15.388|
0000fa  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
0000fc  77c1              STRB     r1,[r0,#0x1f]
;;;336    	pDHCPMSG->chaddr[4] = DHCP_CHADDR[4];
0000fe  4823              LDR      r0,|L15.396|
000100  7901              LDRB     r1,[r0,#4]  ; DHCP_CHADDR
000102  4820              LDR      r0,|L15.388|
000104  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
000106  f8801020          STRB     r1,[r0,#0x20]
;;;337    	pDHCPMSG->chaddr[5] = DHCP_CHADDR[5];
00010a  4820              LDR      r0,|L15.396|
00010c  7941              LDRB     r1,[r0,#5]  ; DHCP_CHADDR
00010e  481d              LDR      r0,|L15.388|
000110  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
000112  f8801021          STRB     r1,[r0,#0x21]
;;;338    
;;;339    	for (i = 6; i < 16; i++)  pDHCPMSG->chaddr[i] = 0;
000116  2406              MOVS     r4,#6
000118  e006              B        |L15.296|
                  |L15.282|
00011a  2100              MOVS     r1,#0
00011c  4819              LDR      r0,|L15.388|
00011e  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
000120  301c              ADDS     r0,r0,#0x1c
000122  5501              STRB     r1,[r0,r4]
000124  1c60              ADDS     r0,r4,#1
000126  b2c4              UXTB     r4,r0
                  |L15.296|
000128  2c10              CMP      r4,#0x10
00012a  dbf6              BLT      |L15.282|
;;;340    	for (i = 0; i < 64; i++)  pDHCPMSG->sname[i]  = 0;
00012c  2400              MOVS     r4,#0
00012e  e006              B        |L15.318|
                  |L15.304|
000130  2100              MOVS     r1,#0
000132  4814              LDR      r0,|L15.388|
000134  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
000136  302c              ADDS     r0,r0,#0x2c
000138  5501              STRB     r1,[r0,r4]
00013a  1c60              ADDS     r0,r4,#1
00013c  b2c4              UXTB     r4,r0
                  |L15.318|
00013e  2c40              CMP      r4,#0x40
000140  dbf6              BLT      |L15.304|
;;;341    	for (i = 0; i < 128; i++) pDHCPMSG->file[i]   = 0;
000142  2400              MOVS     r4,#0
000144  e006              B        |L15.340|
                  |L15.326|
000146  2100              MOVS     r1,#0
000148  480e              LDR      r0,|L15.388|
00014a  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
00014c  306c              ADDS     r0,r0,#0x6c
00014e  5501              STRB     r1,[r0,r4]
000150  1c60              ADDS     r0,r4,#1
000152  b2c4              UXTB     r4,r0
                  |L15.340|
000154  2c80              CMP      r4,#0x80
000156  dbf6              BLT      |L15.326|
;;;342    
;;;343    	// MAGIC_COOKIE
;;;344    	pDHCPMSG->OPT[0] = (uint8_t)((MAGIC_COOKIE & 0xFF000000) >> 24);
000158  2063              MOVS     r0,#0x63
00015a  490a              LDR      r1,|L15.388|
00015c  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
00015e  f88100ec          STRB     r0,[r1,#0xec]
;;;345    	pDHCPMSG->OPT[1] = (uint8_t)((MAGIC_COOKIE & 0x00FF0000) >> 16);
000162  2182              MOVS     r1,#0x82
000164  4807              LDR      r0,|L15.388|
000166  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
000168  f88010ed          STRB     r1,[r0,#0xed]
;;;346    	pDHCPMSG->OPT[2] = (uint8_t)((MAGIC_COOKIE & 0x0000FF00) >>  8);
00016c  2153              MOVS     r1,#0x53
00016e  4805              LDR      r0,|L15.388|
000170  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
000172  f88010ee          STRB     r1,[r0,#0xee]
;;;347    	pDHCPMSG->OPT[3] = (uint8_t) (MAGIC_COOKIE & 0x000000FF) >>  0;
000176  2163              MOVS     r1,#0x63
000178  4802              LDR      r0,|L15.388|
00017a  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
00017c  f88010ef          STRB     r1,[r0,#0xef]
;;;348    }
000180  bd7c              POP      {r2-r6,pc}
;;;349    
                          ENDP

000182  0000              DCW      0x0000
                  |L15.388|
                          DCD      pDHCPMSG
                  |L15.392|
                          DCD      DHCP_XID
                  |L15.396|
                          DCD      DHCP_CHADDR

                          AREA ||i.parseDHCPMSG||, CODE, READONLY, ALIGN=2

                          REQUIRE _printf_percent
                          REQUIRE _printf_d
                          REQUIRE _printf_int_dec
                  parseDHCPMSG PROC
;;;568    /* PARSE REPLY pDHCPMSG */
;;;569    int8_t parseDHCPMSG(void)
000000  e92d41f0          PUSH     {r4-r8,lr}
;;;570    {
000004  b086              SUB      sp,sp,#0x18
;;;571    	uint8_t svr_addr[6];
;;;572    	uint16_t  svr_port;
;;;573    	uint16_t len;
;;;574    
;;;575    	uint8_t * p;
;;;576    	uint8_t * e;
;;;577    	uint8_t type;
;;;578    	uint8_t opt_len;
;;;579       
;;;580       if((len = getSn_RX_RSR(DHCP_SOCKET)) > 0)
000006  4878              LDR      r0,|L16.488|
000008  7800              LDRB     r0,[r0,#0]  ; DHCP_SOCKET
00000a  f7fffffe          BL       getSn_RX_RSR
00000e  1e05              SUBS     r5,r0,#0
000010  dd1a              BLE      |L16.72|
;;;581       {
;;;582       	len = recvfrom(DHCP_SOCKET, (uint8_t *)pDHCPMSG, len, svr_addr, &svr_port);
000012  a803              ADD      r0,sp,#0xc
000014  ab04              ADD      r3,sp,#0x10
000016  462a              MOV      r2,r5
000018  9000              STR      r0,[sp,#0]
00001a  4874              LDR      r0,|L16.492|
00001c  6801              LDR      r1,[r0,#0]  ; pDHCPMSG
00001e  4872              LDR      r0,|L16.488|
000020  7800              LDRB     r0,[r0,#0]  ; DHCP_SOCKET
000022  f7fffffe          BL       recvfrom
000026  b285              UXTH     r5,r0
;;;583       #ifdef _DHCP_DEBUG_   
;;;584          printf("DHCP message : %d.%d.%d.%d(%d) %d received. \r\n",svr_addr[0],svr_addr[1],svr_addr[2], svr_addr[3],svr_port, len);
000028  f8bd100c          LDRH     r1,[sp,#0xc]
00002c  f89d0013          LDRB     r0,[sp,#0x13]
000030  e88d0023          STM      sp,{r0,r1,r5}
000034  f89d3012          LDRB     r3,[sp,#0x12]
000038  f89d2011          LDRB     r2,[sp,#0x11]
00003c  f89d1010          LDRB     r1,[sp,#0x10]
000040  a06b              ADR      r0,|L16.496|
000042  f7fffffe          BL       __2printf
000046  e003              B        |L16.80|
                  |L16.72|
;;;585       #endif   
;;;586       }
;;;587       else return 0;
000048  2000              MOVS     r0,#0
                  |L16.74|
;;;588    	if (svr_port == DHCP_SERVER_PORT) {
;;;589          // compare mac address
;;;590    		if ( (pDHCPMSG->chaddr[0] != DHCP_CHADDR[0]) || (pDHCPMSG->chaddr[1] != DHCP_CHADDR[1]) ||
;;;591    		     (pDHCPMSG->chaddr[2] != DHCP_CHADDR[2]) || (pDHCPMSG->chaddr[3] != DHCP_CHADDR[3]) ||
;;;592    		     (pDHCPMSG->chaddr[4] != DHCP_CHADDR[4]) || (pDHCPMSG->chaddr[5] != DHCP_CHADDR[5])   )
;;;593             return 0;
;;;594          type = 0;
;;;595    		p = (uint8_t *)(&pDHCPMSG->op);
;;;596    		p = p + 240;      // 240 = sizeof(RIP_MSG) + MAGIC_COOKIE size in RIP_MSG.opt - sizeof(RIP_MSG.opt)
;;;597    		e = p + (len - 240);
;;;598    
;;;599    		while ( p < e ) {
;;;600    
;;;601    			switch ( *p ) {
;;;602    
;;;603       			case endOption :
;;;604       			   p = e;   // for break while(p < e)
;;;605       				break;
;;;606                case padOption :
;;;607       				p++;
;;;608       				break;
;;;609       			case dhcpMessageType :
;;;610       				p++;
;;;611       				p++;
;;;612       				type = *p++;
;;;613       				break;
;;;614       			case subnetMask :
;;;615       				p++;
;;;616       				p++;
;;;617       				DHCP_allocated_sn[0] = *p++;
;;;618       				DHCP_allocated_sn[1] = *p++;
;;;619       				DHCP_allocated_sn[2] = *p++;
;;;620       				DHCP_allocated_sn[3] = *p++;
;;;621       				break;
;;;622       			case routersOnSubnet :
;;;623       				p++;
;;;624       				opt_len = *p++;       
;;;625       				DHCP_allocated_gw[0] = *p++;
;;;626       				DHCP_allocated_gw[1] = *p++;
;;;627       				DHCP_allocated_gw[2] = *p++;
;;;628       				DHCP_allocated_gw[3] = *p++;
;;;629       				p = p + (opt_len - 4);
;;;630       				break;
;;;631       			case dns :
;;;632       				p++;                  
;;;633       				opt_len = *p++;       
;;;634       				DHCP_allocated_dns[0] = *p++;
;;;635       				DHCP_allocated_dns[1] = *p++;
;;;636       				DHCP_allocated_dns[2] = *p++;
;;;637       				DHCP_allocated_dns[3] = *p++;
;;;638       				p = p + (opt_len - 4);
;;;639       				break;
;;;640       			case dhcpIPaddrLeaseTime :
;;;641       				p++;
;;;642       				opt_len = *p++;
;;;643       				dhcp_lease_time  = *p++;
;;;644       				dhcp_lease_time  = (dhcp_lease_time << 8) + *p++;
;;;645       				dhcp_lease_time  = (dhcp_lease_time << 8) + *p++;
;;;646       				dhcp_lease_time  = (dhcp_lease_time << 8) + *p++;
;;;647                #ifdef _DHCP_DEBUG_  
;;;648                   //dhcp_lease_time = 10;
;;;649     				#endif
;;;650       				break;
;;;651       			case dhcpServerIdentifier :
;;;652       				p++;
;;;653       				opt_len = *p++;
;;;654       				DHCP_SIP[0] = *p++;
;;;655       				DHCP_SIP[1] = *p++;
;;;656       				DHCP_SIP[2] = *p++;
;;;657       				DHCP_SIP[3] = *p++;
;;;658       				break;
;;;659       			default :
;;;660       				p++;
;;;661       				opt_len = *p++;
;;;662       				p += opt_len;
;;;663       				break;
;;;664    			} // switch
;;;665    		} // while
;;;666    	} // if
;;;667    	return	type;
;;;668    }
00004a  b006              ADD      sp,sp,#0x18
00004c  e8bd81f0          POP      {r4-r8,pc}
                  |L16.80|
000050  f8bd000c          LDRH     r0,[sp,#0xc]          ;588
000054  2843              CMP      r0,#0x43              ;588
000056  d174              BNE      |L16.322|
000058  4864              LDR      r0,|L16.492|
00005a  6800              LDR      r0,[r0,#0]            ;590  ; pDHCPMSG
00005c  7f00              LDRB     r0,[r0,#0x1c]         ;590
00005e  4970              LDR      r1,|L16.544|
000060  7809              LDRB     r1,[r1,#0]            ;590  ; DHCP_CHADDR
000062  4288              CMP      r0,r1                 ;590
000064  d124              BNE      |L16.176|
000066  4861              LDR      r0,|L16.492|
000068  6800              LDR      r0,[r0,#0]            ;590  ; pDHCPMSG
00006a  7f40              LDRB     r0,[r0,#0x1d]         ;590
00006c  496c              LDR      r1,|L16.544|
00006e  7849              LDRB     r1,[r1,#1]            ;590  ; DHCP_CHADDR
000070  4288              CMP      r0,r1                 ;590
000072  d11d              BNE      |L16.176|
000074  485d              LDR      r0,|L16.492|
000076  6800              LDR      r0,[r0,#0]            ;591  ; pDHCPMSG
000078  7f80              LDRB     r0,[r0,#0x1e]         ;591
00007a  4969              LDR      r1,|L16.544|
00007c  7889              LDRB     r1,[r1,#2]            ;591  ; DHCP_CHADDR
00007e  4288              CMP      r0,r1                 ;591
000080  d116              BNE      |L16.176|
000082  485a              LDR      r0,|L16.492|
000084  6800              LDR      r0,[r0,#0]            ;591  ; pDHCPMSG
000086  7fc0              LDRB     r0,[r0,#0x1f]         ;591
000088  4965              LDR      r1,|L16.544|
00008a  78c9              LDRB     r1,[r1,#3]            ;591  ; DHCP_CHADDR
00008c  4288              CMP      r0,r1                 ;591
00008e  d10f              BNE      |L16.176|
000090  4856              LDR      r0,|L16.492|
000092  6800              LDR      r0,[r0,#0]            ;592  ; pDHCPMSG
000094  f8900020          LDRB     r0,[r0,#0x20]         ;592
000098  4961              LDR      r1,|L16.544|
00009a  7909              LDRB     r1,[r1,#4]            ;592  ; DHCP_CHADDR
00009c  4288              CMP      r0,r1                 ;592
00009e  d107              BNE      |L16.176|
0000a0  4852              LDR      r0,|L16.492|
0000a2  6800              LDR      r0,[r0,#0]            ;592  ; pDHCPMSG
0000a4  f8900021          LDRB     r0,[r0,#0x21]         ;592
0000a8  495d              LDR      r1,|L16.544|
0000aa  7949              LDRB     r1,[r1,#5]            ;592  ; DHCP_CHADDR
0000ac  4288              CMP      r0,r1                 ;592
0000ae  d001              BEQ      |L16.180|
                  |L16.176|
0000b0  2000              MOVS     r0,#0                 ;593
0000b2  e7ca              B        |L16.74|
                  |L16.180|
0000b4  f04f0800          MOV      r8,#0                 ;594
0000b8  484c              LDR      r0,|L16.492|
0000ba  6804              LDR      r4,[r0,#0]            ;595  ; pDHCPMSG
0000bc  34f0              ADDS     r4,r4,#0xf0           ;596
0000be  f1a500f0          SUB      r0,r5,#0xf0           ;597
0000c2  1906              ADDS     r6,r0,r4              ;597
0000c4  e089              B        |L16.474|
                  |L16.198|
0000c6  7820              LDRB     r0,[r4,#0]            ;601
0000c8  2833              CMP      r0,#0x33              ;601
0000ca  d04e              BEQ      |L16.362|
0000cc  dc07              BGT      |L16.222|
0000ce  b170              CBZ      r0,|L16.238|
0000d0  2801              CMP      r0,#1                 ;601
0000d2  d013              BEQ      |L16.252|
0000d4  2803              CMP      r0,#3                 ;601
0000d6  d021              BEQ      |L16.284|
0000d8  2806              CMP      r0,#6                 ;601
0000da  d178              BNE      |L16.462|
0000dc  e032              B        |L16.324|
                  |L16.222|
0000de  2835              CMP      r0,#0x35              ;601
0000e0  d007              BEQ      |L16.242|
0000e2  2836              CMP      r0,#0x36              ;601
0000e4  d061              BEQ      |L16.426|
0000e6  28ff              CMP      r0,#0xff              ;601
0000e8  d171              BNE      |L16.462|
0000ea  4634              MOV      r4,r6                 ;604
0000ec  e074              B        |L16.472|
                  |L16.238|
0000ee  1c64              ADDS     r4,r4,#1              ;607
0000f0  e072              B        |L16.472|
                  |L16.242|
0000f2  1c64              ADDS     r4,r4,#1              ;610
0000f4  1c64              ADDS     r4,r4,#1              ;611
0000f6  f8148b01          LDRB     r8,[r4],#1            ;612
0000fa  e06d              B        |L16.472|
                  |L16.252|
0000fc  1c64              ADDS     r4,r4,#1              ;615
0000fe  1c64              ADDS     r4,r4,#1              ;616
000100  f8140b01          LDRB     r0,[r4],#1            ;617
000104  4947              LDR      r1,|L16.548|
000106  7008              STRB     r0,[r1,#0]            ;617
000108  f8140b01          LDRB     r0,[r4],#1            ;618
00010c  7048              STRB     r0,[r1,#1]            ;618
00010e  f8140b01          LDRB     r0,[r4],#1            ;619
000112  7088              STRB     r0,[r1,#2]            ;619
000114  f8140b01          LDRB     r0,[r4],#1            ;620
000118  70c8              STRB     r0,[r1,#3]            ;620
00011a  e05d              B        |L16.472|
                  |L16.284|
00011c  1c64              ADDS     r4,r4,#1              ;623
00011e  f8147b01          LDRB     r7,[r4],#1            ;624
000122  f8140b01          LDRB     r0,[r4],#1            ;625
000126  4940              LDR      r1,|L16.552|
000128  7008              STRB     r0,[r1,#0]            ;625
00012a  f8140b01          LDRB     r0,[r4],#1            ;626
00012e  7048              STRB     r0,[r1,#1]            ;626
000130  f8140b01          LDRB     r0,[r4],#1            ;627
000134  7088              STRB     r0,[r1,#2]            ;627
000136  f8140b01          LDRB     r0,[r4],#1            ;628
00013a  70c8              STRB     r0,[r1,#3]            ;628
00013c  1f38              SUBS     r0,r7,#4              ;629
00013e  4404              ADD      r4,r4,r0              ;629
000140  e04a              B        |L16.472|
                  |L16.322|
000142  e04d              B        |L16.480|
                  |L16.324|
000144  1c64              ADDS     r4,r4,#1              ;632
000146  f8147b01          LDRB     r7,[r4],#1            ;633
00014a  f8140b01          LDRB     r0,[r4],#1            ;634
00014e  4937              LDR      r1,|L16.556|
000150  7008              STRB     r0,[r1,#0]            ;634
000152  f8140b01          LDRB     r0,[r4],#1            ;635
000156  7048              STRB     r0,[r1,#1]            ;635
000158  f8140b01          LDRB     r0,[r4],#1            ;636
00015c  7088              STRB     r0,[r1,#2]            ;636
00015e  f8140b01          LDRB     r0,[r4],#1            ;637
000162  70c8              STRB     r0,[r1,#3]            ;637
000164  1f38              SUBS     r0,r7,#4              ;638
000166  4404              ADD      r4,r4,r0              ;638
000168  e036              B        |L16.472|
                  |L16.362|
00016a  1c64              ADDS     r4,r4,#1              ;641
00016c  f8147b01          LDRB     r7,[r4],#1            ;642
000170  f8140b01          LDRB     r0,[r4],#1            ;643
000174  492e              LDR      r1,|L16.560|
000176  6008              STR      r0,[r1,#0]            ;643  ; dhcp_lease_time
000178  f8141b01          LDRB     r1,[r4],#1            ;644
00017c  482c              LDR      r0,|L16.560|
00017e  6800              LDR      r0,[r0,#0]            ;644  ; dhcp_lease_time
000180  eb012000          ADD      r0,r1,r0,LSL #8       ;644
000184  492a              LDR      r1,|L16.560|
000186  6008              STR      r0,[r1,#0]            ;644  ; dhcp_lease_time
000188  f8141b01          LDRB     r1,[r4],#1            ;645
00018c  4828              LDR      r0,|L16.560|
00018e  6800              LDR      r0,[r0,#0]            ;645  ; dhcp_lease_time
000190  eb012000          ADD      r0,r1,r0,LSL #8       ;645
000194  4926              LDR      r1,|L16.560|
000196  6008              STR      r0,[r1,#0]            ;645  ; dhcp_lease_time
000198  f8141b01          LDRB     r1,[r4],#1            ;646
00019c  4824              LDR      r0,|L16.560|
00019e  6800              LDR      r0,[r0,#0]            ;646  ; dhcp_lease_time
0001a0  eb012000          ADD      r0,r1,r0,LSL #8       ;646
0001a4  4922              LDR      r1,|L16.560|
0001a6  6008              STR      r0,[r1,#0]            ;646  ; dhcp_lease_time
0001a8  e016              B        |L16.472|
                  |L16.426|
0001aa  1c64              ADDS     r4,r4,#1              ;652
0001ac  f8147b01          LDRB     r7,[r4],#1            ;653
0001b0  f8140b01          LDRB     r0,[r4],#1            ;654
0001b4  491f              LDR      r1,|L16.564|
0001b6  7008              STRB     r0,[r1,#0]            ;654
0001b8  f8140b01          LDRB     r0,[r4],#1            ;655
0001bc  7048              STRB     r0,[r1,#1]            ;655
0001be  f8140b01          LDRB     r0,[r4],#1            ;656
0001c2  7088              STRB     r0,[r1,#2]            ;656
0001c4  f8140b01          LDRB     r0,[r4],#1            ;657
0001c8  70c8              STRB     r0,[r1,#3]            ;657
0001ca  e005              B        |L16.472|
0001cc  e7ff              B        |L16.462|
                  |L16.462|
0001ce  1c64              ADDS     r4,r4,#1              ;660
0001d0  f8147b01          LDRB     r7,[r4],#1            ;661
0001d4  443c              ADD      r4,r4,r7              ;662
0001d6  bf00              NOP                            ;663
                  |L16.472|
0001d8  bf00              NOP                            ;605
                  |L16.474|
0001da  42b4              CMP      r4,r6                 ;599
0001dc  f4ffaf73          BCC      |L16.198|
                  |L16.480|
0001e0  fa4ff088          SXTB     r0,r8                 ;667
0001e4  e731              B        |L16.74|
;;;669    
                          ENDP

0001e6  0000              DCW      0x0000
                  |L16.488|
                          DCD      DHCP_SOCKET
                  |L16.492|
                          DCD      pDHCPMSG
                  |L16.496|
0001f0  44484350          DCB      "DHCP message : %d.%d.%d.%d(%d) %d received. \r\n",0
0001f4  206d6573
0001f8  73616765
0001fc  203a2025
000200  642e2564
000204  2e25642e
000208  25642825
00020c  64292025
000210  64207265
000214  63656976
000218  65642e20
00021c  0d0a00  
00021f  00                DCB      0
                  |L16.544|
                          DCD      DHCP_CHADDR
                  |L16.548|
                          DCD      DHCP_allocated_sn
                  |L16.552|
                          DCD      DHCP_allocated_gw
                  |L16.556|
                          DCD      DHCP_allocated_dns
                  |L16.560|
                          DCD      dhcp_lease_time
                  |L16.564|
                          DCD      DHCP_SIP

                          AREA ||i.reg_dhcp_cbfunc||, CODE, READONLY, ALIGN=2

                  reg_dhcp_cbfunc PROC
;;;280    /* register the call back func. */
;;;281    void reg_dhcp_cbfunc(void(*ip_assign)(void), void(*ip_update)(void), void(*ip_conflict)(void))
000000  b510              PUSH     {r4,lr}
;;;282    {
;;;283       dhcp_ip_assign   = default_ip_assign;
000002  4b09              LDR      r3,|L17.40|
000004  4c09              LDR      r4,|L17.44|
000006  6023              STR      r3,[r4,#0]  ; dhcp_ip_assign
;;;284       dhcp_ip_update   = default_ip_update;
000008  4b09              LDR      r3,|L17.48|
00000a  4c0a              LDR      r4,|L17.52|
00000c  6023              STR      r3,[r4,#0]  ; dhcp_ip_update
;;;285       dhcp_ip_conflict = default_ip_conflict;
00000e  4b0a              LDR      r3,|L17.56|
000010  4c0a              LDR      r4,|L17.60|
000012  6023              STR      r3,[r4,#0]  ; dhcp_ip_conflict
;;;286       if(ip_assign)   dhcp_ip_assign = ip_assign;
000014  b108              CBZ      r0,|L17.26|
000016  4b05              LDR      r3,|L17.44|
000018  6018              STR      r0,[r3,#0]  ; dhcp_ip_assign
                  |L17.26|
;;;287       if(ip_update)   dhcp_ip_update = ip_update;
00001a  b109              CBZ      r1,|L17.32|
00001c  4b05              LDR      r3,|L17.52|
00001e  6019              STR      r1,[r3,#0]  ; dhcp_ip_update
                  |L17.32|
;;;288       if(ip_conflict) dhcp_ip_conflict = ip_conflict;
000020  b10a              CBZ      r2,|L17.38|
000022  4b06              LDR      r3,|L17.60|
000024  601a              STR      r2,[r3,#0]  ; dhcp_ip_conflict
                  |L17.38|
;;;289    }
000026  bd10              POP      {r4,pc}
;;;290    
                          ENDP

                  |L17.40|
                          DCD      default_ip_assign
                  |L17.44|
                          DCD      dhcp_ip_assign
                  |L17.48|
                          DCD      default_ip_update
                  |L17.52|
                          DCD      dhcp_ip_update
                  |L17.56|
                          DCD      default_ip_conflict
                  |L17.60|
                          DCD      dhcp_ip_conflict

                          AREA ||i.reset_DHCP_timeout||, CODE, READONLY, ALIGN=2

                  reset_DHCP_timeout PROC
;;;924    /* Rset the DHCP timeout count and retry count. */
;;;925    void reset_DHCP_timeout(void)
000000  2000              MOVS     r0,#0
;;;926    {
;;;927    	dhcp_tick_1s = 0;
000002  4904              LDR      r1,|L18.20|
000004  6008              STR      r0,[r1,#0]  ; dhcp_tick_1s
;;;928    	dhcp_tick_next = DHCP_WAIT_TIME;
000006  200a              MOVS     r0,#0xa
000008  4903              LDR      r1,|L18.24|
00000a  6008              STR      r0,[r1,#0]  ; dhcp_tick_next
;;;929    	dhcp_retry_count = 0;
00000c  2000              MOVS     r0,#0
00000e  4903              LDR      r1,|L18.28|
000010  7008              STRB     r0,[r1,#0]
;;;930    }
000012  4770              BX       lr
;;;931    
                          ENDP

                  |L18.20|
                          DCD      dhcp_tick_1s
                  |L18.24|
                          DCD      dhcp_tick_next
                  |L18.28|
                          DCD      dhcp_retry_count

                          AREA ||i.send_DHCP_DECLINE||, CODE, READONLY, ALIGN=2

                  send_DHCP_DECLINE PROC
;;;508    /* SEND DHCP DHCPDECLINE */
;;;509    void send_DHCP_DECLINE(void)
000000  b57c              PUSH     {r2-r6,lr}
;;;510    {
;;;511    	int i;
;;;512    	uint8_t ip[4];
;;;513    	uint16_t k = 0;
000002  2400              MOVS     r4,#0
;;;514    	
;;;515    	makeDHCPMSG();
000004  f7fffffe          BL       makeDHCPMSG
;;;516    
;;;517       k = 4;      // beacaue MAGIC_COOKIE already made by makeDHCPMSG()
000008  2404              MOVS     r4,#4
;;;518       
;;;519    	*((uint8_t*)(&pDHCPMSG->flags))   = ((DHCP_FLAGSUNICAST & 0xFF00)>> 8);
00000a  2000              MOVS     r0,#0
00000c  4979              LDR      r1,|L19.500|
00000e  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
000010  7288              STRB     r0,[r1,#0xa]
;;;520    	*((uint8_t*)(&pDHCPMSG->flags)+1) = (DHCP_FLAGSUNICAST & 0x00FF);
000012  2100              MOVS     r1,#0
000014  4877              LDR      r0,|L19.500|
000016  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
000018  72c1              STRB     r1,[r0,#0xb]
;;;521    
;;;522    	// Option Request Param.
;;;523    	pDHCPMSG->OPT[k++] = dhcpMessageType;
00001a  2235              MOVS     r2,#0x35
00001c  4621              MOV      r1,r4
00001e  1c64              ADDS     r4,r4,#1
000020  4874              LDR      r0,|L19.500|
000022  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
000024  30ec              ADDS     r0,r0,#0xec
000026  5442              STRB     r2,[r0,r1]
;;;524    	pDHCPMSG->OPT[k++] = 0x01;
000028  2201              MOVS     r2,#1
00002a  4621              MOV      r1,r4
00002c  1c64              ADDS     r4,r4,#1
00002e  4871              LDR      r0,|L19.500|
000030  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
000032  30ec              ADDS     r0,r0,#0xec
000034  5442              STRB     r2,[r0,r1]
;;;525    	pDHCPMSG->OPT[k++] = DHCP_DECLINE;
000036  2204              MOVS     r2,#4
000038  4621              MOV      r1,r4
00003a  1c64              ADDS     r4,r4,#1
00003c  486d              LDR      r0,|L19.500|
00003e  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
000040  30ec              ADDS     r0,r0,#0xec
000042  5442              STRB     r2,[r0,r1]
;;;526    
;;;527    	pDHCPMSG->OPT[k++] = dhcpClientIdentifier;
000044  223d              MOVS     r2,#0x3d
000046  4621              MOV      r1,r4
000048  1c64              ADDS     r4,r4,#1
00004a  486a              LDR      r0,|L19.500|
00004c  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
00004e  30ec              ADDS     r0,r0,#0xec
000050  5442              STRB     r2,[r0,r1]
;;;528    	pDHCPMSG->OPT[k++] = 0x07;
000052  2207              MOVS     r2,#7
000054  4621              MOV      r1,r4
000056  1c64              ADDS     r4,r4,#1
000058  4866              LDR      r0,|L19.500|
00005a  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
00005c  30ec              ADDS     r0,r0,#0xec
00005e  5442              STRB     r2,[r0,r1]
;;;529    	pDHCPMSG->OPT[k++] = 0x01;
000060  2201              MOVS     r2,#1
000062  4621              MOV      r1,r4
000064  1c64              ADDS     r4,r4,#1
000066  4863              LDR      r0,|L19.500|
000068  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
00006a  30ec              ADDS     r0,r0,#0xec
00006c  5442              STRB     r2,[r0,r1]
;;;530    	pDHCPMSG->OPT[k++] = DHCP_CHADDR[0];
00006e  4862              LDR      r0,|L19.504|
000070  7802              LDRB     r2,[r0,#0]  ; DHCP_CHADDR
000072  4621              MOV      r1,r4
000074  1c64              ADDS     r4,r4,#1
000076  485f              LDR      r0,|L19.500|
000078  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
00007a  30ec              ADDS     r0,r0,#0xec
00007c  5442              STRB     r2,[r0,r1]
;;;531    	pDHCPMSG->OPT[k++] = DHCP_CHADDR[1];
00007e  485e              LDR      r0,|L19.504|
000080  7842              LDRB     r2,[r0,#1]  ; DHCP_CHADDR
000082  4621              MOV      r1,r4
000084  1c64              ADDS     r4,r4,#1
000086  485b              LDR      r0,|L19.500|
000088  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
00008a  30ec              ADDS     r0,r0,#0xec
00008c  5442              STRB     r2,[r0,r1]
;;;532    	pDHCPMSG->OPT[k++] = DHCP_CHADDR[2];
00008e  485a              LDR      r0,|L19.504|
000090  7882              LDRB     r2,[r0,#2]  ; DHCP_CHADDR
000092  4621              MOV      r1,r4
000094  1c64              ADDS     r4,r4,#1
000096  4857              LDR      r0,|L19.500|
000098  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
00009a  30ec              ADDS     r0,r0,#0xec
00009c  5442              STRB     r2,[r0,r1]
;;;533    	pDHCPMSG->OPT[k++] = DHCP_CHADDR[3];
00009e  4856              LDR      r0,|L19.504|
0000a0  78c2              LDRB     r2,[r0,#3]  ; DHCP_CHADDR
0000a2  4621              MOV      r1,r4
0000a4  1c64              ADDS     r4,r4,#1
0000a6  4853              LDR      r0,|L19.500|
0000a8  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
0000aa  30ec              ADDS     r0,r0,#0xec
0000ac  5442              STRB     r2,[r0,r1]
;;;534    	pDHCPMSG->OPT[k++] = DHCP_CHADDR[4];
0000ae  4852              LDR      r0,|L19.504|
0000b0  7902              LDRB     r2,[r0,#4]  ; DHCP_CHADDR
0000b2  4621              MOV      r1,r4
0000b4  1c64              ADDS     r4,r4,#1
0000b6  484f              LDR      r0,|L19.500|
0000b8  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
0000ba  30ec              ADDS     r0,r0,#0xec
0000bc  5442              STRB     r2,[r0,r1]
;;;535    	pDHCPMSG->OPT[k++] = DHCP_CHADDR[5];
0000be  484e              LDR      r0,|L19.504|
0000c0  7942              LDRB     r2,[r0,#5]  ; DHCP_CHADDR
0000c2  4621              MOV      r1,r4
0000c4  1c64              ADDS     r4,r4,#1
0000c6  484b              LDR      r0,|L19.500|
0000c8  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
0000ca  30ec              ADDS     r0,r0,#0xec
0000cc  5442              STRB     r2,[r0,r1]
;;;536    
;;;537    	pDHCPMSG->OPT[k++] = dhcpRequestedIPaddr;
0000ce  2232              MOVS     r2,#0x32
0000d0  4621              MOV      r1,r4
0000d2  1c64              ADDS     r4,r4,#1
0000d4  4847              LDR      r0,|L19.500|
0000d6  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
0000d8  30ec              ADDS     r0,r0,#0xec
0000da  5442              STRB     r2,[r0,r1]
;;;538    	pDHCPMSG->OPT[k++] = 0x04;
0000dc  2204              MOVS     r2,#4
0000de  4620              MOV      r0,r4
0000e0  1c61              ADDS     r1,r4,#1
0000e2  b28c              UXTH     r4,r1
0000e4  4943              LDR      r1,|L19.500|
0000e6  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
0000e8  31ec              ADDS     r1,r1,#0xec
0000ea  540a              STRB     r2,[r1,r0]
;;;539    	pDHCPMSG->OPT[k++] = DHCP_allocated_ip[0];
0000ec  4843              LDR      r0,|L19.508|
0000ee  7802              LDRB     r2,[r0,#0]  ; DHCP_allocated_ip
0000f0  4620              MOV      r0,r4
0000f2  1c61              ADDS     r1,r4,#1
0000f4  b28c              UXTH     r4,r1
0000f6  493f              LDR      r1,|L19.500|
0000f8  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
0000fa  31ec              ADDS     r1,r1,#0xec
0000fc  540a              STRB     r2,[r1,r0]
;;;540    	pDHCPMSG->OPT[k++] = DHCP_allocated_ip[1];
0000fe  483f              LDR      r0,|L19.508|
000100  7842              LDRB     r2,[r0,#1]  ; DHCP_allocated_ip
000102  4620              MOV      r0,r4
000104  1c61              ADDS     r1,r4,#1
000106  b28c              UXTH     r4,r1
000108  493a              LDR      r1,|L19.500|
00010a  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
00010c  31ec              ADDS     r1,r1,#0xec
00010e  540a              STRB     r2,[r1,r0]
;;;541    	pDHCPMSG->OPT[k++] = DHCP_allocated_ip[2];
000110  483a              LDR      r0,|L19.508|
000112  7882              LDRB     r2,[r0,#2]  ; DHCP_allocated_ip
000114  4620              MOV      r0,r4
000116  1c61              ADDS     r1,r4,#1
000118  b28c              UXTH     r4,r1
00011a  4936              LDR      r1,|L19.500|
00011c  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
00011e  31ec              ADDS     r1,r1,#0xec
000120  540a              STRB     r2,[r1,r0]
;;;542    	pDHCPMSG->OPT[k++] = DHCP_allocated_ip[3];
000122  4836              LDR      r0,|L19.508|
000124  78c2              LDRB     r2,[r0,#3]  ; DHCP_allocated_ip
000126  4620              MOV      r0,r4
000128  1c61              ADDS     r1,r4,#1
00012a  b28c              UXTH     r4,r1
00012c  4931              LDR      r1,|L19.500|
00012e  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
000130  31ec              ADDS     r1,r1,#0xec
000132  540a              STRB     r2,[r1,r0]
;;;543    
;;;544    	pDHCPMSG->OPT[k++] = dhcpServerIdentifier;
000134  2236              MOVS     r2,#0x36
000136  4620              MOV      r0,r4
000138  1c61              ADDS     r1,r4,#1
00013a  b28c              UXTH     r4,r1
00013c  492d              LDR      r1,|L19.500|
00013e  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
000140  31ec              ADDS     r1,r1,#0xec
000142  540a              STRB     r2,[r1,r0]
;;;545    	pDHCPMSG->OPT[k++] = 0x04;
000144  2204              MOVS     r2,#4
000146  4620              MOV      r0,r4
000148  1c61              ADDS     r1,r4,#1
00014a  b28c              UXTH     r4,r1
00014c  4929              LDR      r1,|L19.500|
00014e  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
000150  31ec              ADDS     r1,r1,#0xec
000152  540a              STRB     r2,[r1,r0]
;;;546    	pDHCPMSG->OPT[k++] = DHCP_SIP[0];
000154  482a              LDR      r0,|L19.512|
000156  7802              LDRB     r2,[r0,#0]  ; DHCP_SIP
000158  4620              MOV      r0,r4
00015a  1c61              ADDS     r1,r4,#1
00015c  b28c              UXTH     r4,r1
00015e  4925              LDR      r1,|L19.500|
000160  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
000162  31ec              ADDS     r1,r1,#0xec
000164  540a              STRB     r2,[r1,r0]
;;;547    	pDHCPMSG->OPT[k++] = DHCP_SIP[1];
000166  4826              LDR      r0,|L19.512|
000168  7842              LDRB     r2,[r0,#1]  ; DHCP_SIP
00016a  4620              MOV      r0,r4
00016c  1c61              ADDS     r1,r4,#1
00016e  b28c              UXTH     r4,r1
000170  4920              LDR      r1,|L19.500|
000172  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
000174  31ec              ADDS     r1,r1,#0xec
000176  540a              STRB     r2,[r1,r0]
;;;548    	pDHCPMSG->OPT[k++] = DHCP_SIP[2];
000178  4821              LDR      r0,|L19.512|
00017a  7882              LDRB     r2,[r0,#2]  ; DHCP_SIP
00017c  4620              MOV      r0,r4
00017e  1c61              ADDS     r1,r4,#1
000180  b28c              UXTH     r4,r1
000182  491c              LDR      r1,|L19.500|
000184  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
000186  31ec              ADDS     r1,r1,#0xec
000188  540a              STRB     r2,[r1,r0]
;;;549    	pDHCPMSG->OPT[k++] = DHCP_SIP[3];
00018a  481d              LDR      r0,|L19.512|
00018c  78c2              LDRB     r2,[r0,#3]  ; DHCP_SIP
00018e  4620              MOV      r0,r4
000190  1c61              ADDS     r1,r4,#1
000192  b28c              UXTH     r4,r1
000194  4917              LDR      r1,|L19.500|
000196  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
000198  31ec              ADDS     r1,r1,#0xec
00019a  540a              STRB     r2,[r1,r0]
;;;550    
;;;551    	pDHCPMSG->OPT[k++] = endOption;
00019c  22ff              MOVS     r2,#0xff
00019e  4620              MOV      r0,r4
0001a0  1c61              ADDS     r1,r4,#1
0001a2  b28c              UXTH     r4,r1
0001a4  4913              LDR      r1,|L19.500|
0001a6  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
0001a8  31ec              ADDS     r1,r1,#0xec
0001aa  540a              STRB     r2,[r1,r0]
;;;552    
;;;553    	for (i = k; i < OPT_SIZE; i++) pDHCPMSG->OPT[i] = 0;
0001ac  4625              MOV      r5,r4
0001ae  e005              B        |L19.444|
                  |L19.432|
0001b0  2100              MOVS     r1,#0
0001b2  4810              LDR      r0,|L19.500|
0001b4  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
0001b6  30ec              ADDS     r0,r0,#0xec
0001b8  5541              STRB     r1,[r0,r5]
0001ba  1c6d              ADDS     r5,r5,#1
                  |L19.444|
0001bc  f5b57f9c          CMP      r5,#0x138
0001c0  dbf6              BLT      |L19.432|
;;;554    
;;;555    	//send broadcasting packet
;;;556    	ip[0] = 0xFF;
0001c2  20ff              MOVS     r0,#0xff
0001c4  f88d0004          STRB     r0,[sp,#4]
;;;557    	ip[1] = 0xFF;
0001c8  f88d0005          STRB     r0,[sp,#5]
;;;558    	ip[2] = 0xFF;
0001cc  f88d0006          STRB     r0,[sp,#6]
;;;559    	ip[3] = 0xFF;
0001d0  f88d0007          STRB     r0,[sp,#7]
;;;560    
;;;561    #ifdef _DHCP_DEBUG_
;;;562    	printf("\r\n> Send DHCP_DECLINE\r\n");
0001d4  a00b              ADR      r0,|L19.516|
0001d6  f7fffffe          BL       __2printf
;;;563    #endif
;;;564    
;;;565    	sendto(DHCP_SOCKET, (uint8_t *)pDHCPMSG, RIP_MSG_SIZE, ip, DHCP_SERVER_PORT);
0001da  2043              MOVS     r0,#0x43
0001dc  ab01              ADD      r3,sp,#4
0001de  f44f7209          MOV      r2,#0x224
0001e2  9000              STR      r0,[sp,#0]
0001e4  4803              LDR      r0,|L19.500|
0001e6  6801              LDR      r1,[r0,#0]  ; pDHCPMSG
0001e8  480c              LDR      r0,|L19.540|
0001ea  7800              LDRB     r0,[r0,#0]  ; DHCP_SOCKET
0001ec  f7fffffe          BL       sendto
;;;566    }
0001f0  bd7c              POP      {r2-r6,pc}
;;;567    
                          ENDP

0001f2  0000              DCW      0x0000
                  |L19.500|
                          DCD      pDHCPMSG
                  |L19.504|
                          DCD      DHCP_CHADDR
                  |L19.508|
                          DCD      DHCP_allocated_ip
                  |L19.512|
                          DCD      DHCP_SIP
                  |L19.516|
000204  0d0a3e20          DCB      "\r\n> Send DHCP_DECLINE\r\n",0
000208  53656e64
00020c  20444843
000210  505f4445
000214  434c494e
000218  450d0a00
                  |L19.540|
                          DCD      DHCP_SOCKET

                          AREA ||i.send_DHCP_DISCOVER||, CODE, READONLY, ALIGN=2

                  send_DHCP_DISCOVER PROC
;;;350    /* SEND DHCP DISCOVER */
;;;351    void send_DHCP_DISCOVER(void)
000000  b57c              PUSH     {r2-r6,lr}
;;;352    {
;;;353    	uint16_t i;
;;;354    	uint8_t ip[4];
;;;355    	uint16_t k = 0;
000002  2400              MOVS     r4,#0
;;;356       
;;;357       makeDHCPMSG();
000004  f7fffffe          BL       makeDHCPMSG
;;;358    
;;;359       k = 4;     // beacaue MAGIC_COOKIE already made by makeDHCPMSG()
000008  2404              MOVS     r4,#4
;;;360       
;;;361    	// Option Request Param
;;;362    	pDHCPMSG->OPT[k++] = dhcpMessageType;
00000a  2235              MOVS     r2,#0x35
00000c  4621              MOV      r1,r4
00000e  1c64              ADDS     r4,r4,#1
000010  4882              LDR      r0,|L20.540|
000012  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
000014  30ec              ADDS     r0,r0,#0xec
000016  5442              STRB     r2,[r0,r1]
;;;363    	pDHCPMSG->OPT[k++] = 0x01;
000018  2201              MOVS     r2,#1
00001a  4621              MOV      r1,r4
00001c  1c64              ADDS     r4,r4,#1
00001e  487f              LDR      r0,|L20.540|
000020  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
000022  30ec              ADDS     r0,r0,#0xec
000024  5442              STRB     r2,[r0,r1]
;;;364    	pDHCPMSG->OPT[k++] = DHCP_DISCOVER;
000026  4621              MOV      r1,r4
000028  1c64              ADDS     r4,r4,#1
00002a  487c              LDR      r0,|L20.540|
00002c  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
00002e  30ec              ADDS     r0,r0,#0xec
000030  5442              STRB     r2,[r0,r1]
;;;365    	
;;;366    	// Client identifier
;;;367    	pDHCPMSG->OPT[k++] = dhcpClientIdentifier;
000032  223d              MOVS     r2,#0x3d
000034  4621              MOV      r1,r4
000036  1c64              ADDS     r4,r4,#1
000038  4878              LDR      r0,|L20.540|
00003a  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
00003c  30ec              ADDS     r0,r0,#0xec
00003e  5442              STRB     r2,[r0,r1]
;;;368    	pDHCPMSG->OPT[k++] = 0x07;
000040  2207              MOVS     r2,#7
000042  4621              MOV      r1,r4
000044  1c64              ADDS     r4,r4,#1
000046  4875              LDR      r0,|L20.540|
000048  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
00004a  30ec              ADDS     r0,r0,#0xec
00004c  5442              STRB     r2,[r0,r1]
;;;369    	pDHCPMSG->OPT[k++] = 0x01;
00004e  2201              MOVS     r2,#1
000050  4621              MOV      r1,r4
000052  1c64              ADDS     r4,r4,#1
000054  4871              LDR      r0,|L20.540|
000056  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
000058  30ec              ADDS     r0,r0,#0xec
00005a  5442              STRB     r2,[r0,r1]
;;;370    	pDHCPMSG->OPT[k++] = DHCP_CHADDR[0];
00005c  4870              LDR      r0,|L20.544|
00005e  7802              LDRB     r2,[r0,#0]  ; DHCP_CHADDR
000060  4621              MOV      r1,r4
000062  1c64              ADDS     r4,r4,#1
000064  486d              LDR      r0,|L20.540|
000066  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
000068  30ec              ADDS     r0,r0,#0xec
00006a  5442              STRB     r2,[r0,r1]
;;;371    	pDHCPMSG->OPT[k++] = DHCP_CHADDR[1];
00006c  486c              LDR      r0,|L20.544|
00006e  7842              LDRB     r2,[r0,#1]  ; DHCP_CHADDR
000070  4621              MOV      r1,r4
000072  1c64              ADDS     r4,r4,#1
000074  4869              LDR      r0,|L20.540|
000076  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
000078  30ec              ADDS     r0,r0,#0xec
00007a  5442              STRB     r2,[r0,r1]
;;;372    	pDHCPMSG->OPT[k++] = DHCP_CHADDR[2];
00007c  4868              LDR      r0,|L20.544|
00007e  7882              LDRB     r2,[r0,#2]  ; DHCP_CHADDR
000080  4621              MOV      r1,r4
000082  1c64              ADDS     r4,r4,#1
000084  4865              LDR      r0,|L20.540|
000086  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
000088  30ec              ADDS     r0,r0,#0xec
00008a  5442              STRB     r2,[r0,r1]
;;;373    	pDHCPMSG->OPT[k++] = DHCP_CHADDR[3];
00008c  4864              LDR      r0,|L20.544|
00008e  78c2              LDRB     r2,[r0,#3]  ; DHCP_CHADDR
000090  4621              MOV      r1,r4
000092  1c64              ADDS     r4,r4,#1
000094  4861              LDR      r0,|L20.540|
000096  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
000098  30ec              ADDS     r0,r0,#0xec
00009a  5442              STRB     r2,[r0,r1]
;;;374    	pDHCPMSG->OPT[k++] = DHCP_CHADDR[4];
00009c  4860              LDR      r0,|L20.544|
00009e  7902              LDRB     r2,[r0,#4]  ; DHCP_CHADDR
0000a0  4621              MOV      r1,r4
0000a2  1c64              ADDS     r4,r4,#1
0000a4  485d              LDR      r0,|L20.540|
0000a6  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
0000a8  30ec              ADDS     r0,r0,#0xec
0000aa  5442              STRB     r2,[r0,r1]
;;;375    	pDHCPMSG->OPT[k++] = DHCP_CHADDR[5];
0000ac  485c              LDR      r0,|L20.544|
0000ae  7942              LDRB     r2,[r0,#5]  ; DHCP_CHADDR
0000b0  4621              MOV      r1,r4
0000b2  1c64              ADDS     r4,r4,#1
0000b4  4859              LDR      r0,|L20.540|
0000b6  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
0000b8  30ec              ADDS     r0,r0,#0xec
0000ba  5442              STRB     r2,[r0,r1]
;;;376    	
;;;377    	// host name
;;;378    	pDHCPMSG->OPT[k++] = hostName;
0000bc  220c              MOVS     r2,#0xc
0000be  4621              MOV      r1,r4
0000c0  1c64              ADDS     r4,r4,#1
0000c2  4856              LDR      r0,|L20.540|
0000c4  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
0000c6  30ec              ADDS     r0,r0,#0xec
0000c8  5442              STRB     r2,[r0,r1]
;;;379    	pDHCPMSG->OPT[k++] = 0;          // fill zero length of hostname 
0000ca  2200              MOVS     r2,#0
0000cc  4620              MOV      r0,r4
0000ce  1c61              ADDS     r1,r4,#1
0000d0  b28c              UXTH     r4,r1
0000d2  4952              LDR      r1,|L20.540|
0000d4  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
0000d6  31ec              ADDS     r1,r1,#0xec
0000d8  540a              STRB     r2,[r1,r0]
;;;380    	for(i = 0 ; HOST_NAME[i] != 0; i++)
0000da  2500              MOVS     r5,#0
0000dc  e00a              B        |L20.244|
                  |L20.222|
;;;381       	pDHCPMSG->OPT[k++] = HOST_NAME[i];
0000de  4851              LDR      r0,|L20.548|
0000e0  5d42              LDRB     r2,[r0,r5]
0000e2  4620              MOV      r0,r4
0000e4  1c61              ADDS     r1,r4,#1
0000e6  b28c              UXTH     r4,r1
0000e8  494c              LDR      r1,|L20.540|
0000ea  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
0000ec  31ec              ADDS     r1,r1,#0xec
0000ee  540a              STRB     r2,[r1,r0]
0000f0  1c68              ADDS     r0,r5,#1              ;380
0000f2  b285              UXTH     r5,r0                 ;380
                  |L20.244|
0000f4  484b              LDR      r0,|L20.548|
0000f6  5d40              LDRB     r0,[r0,r5]            ;380
0000f8  2800              CMP      r0,#0                 ;380
0000fa  d1f0              BNE      |L20.222|
;;;382    	pDHCPMSG->OPT[k++] = DHCP_CHADDR[3];
0000fc  4848              LDR      r0,|L20.544|
0000fe  78c2              LDRB     r2,[r0,#3]  ; DHCP_CHADDR
000100  4620              MOV      r0,r4
000102  1c61              ADDS     r1,r4,#1
000104  b28c              UXTH     r4,r1
000106  4945              LDR      r1,|L20.540|
000108  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
00010a  31ec              ADDS     r1,r1,#0xec
00010c  540a              STRB     r2,[r1,r0]
;;;383    	pDHCPMSG->OPT[k++] = DHCP_CHADDR[4];
00010e  4844              LDR      r0,|L20.544|
000110  7902              LDRB     r2,[r0,#4]  ; DHCP_CHADDR
000112  4620              MOV      r0,r4
000114  1c61              ADDS     r1,r4,#1
000116  b28c              UXTH     r4,r1
000118  4940              LDR      r1,|L20.540|
00011a  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
00011c  31ec              ADDS     r1,r1,#0xec
00011e  540a              STRB     r2,[r1,r0]
;;;384    	pDHCPMSG->OPT[k++] = DHCP_CHADDR[5];
000120  483f              LDR      r0,|L20.544|
000122  7942              LDRB     r2,[r0,#5]  ; DHCP_CHADDR
000124  4620              MOV      r0,r4
000126  1c61              ADDS     r1,r4,#1
000128  b28c              UXTH     r4,r1
00012a  493c              LDR      r1,|L20.540|
00012c  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
00012e  31ec              ADDS     r1,r1,#0xec
000130  540a              STRB     r2,[r1,r0]
;;;385    	pDHCPMSG->OPT[k - (i+3+1)] = i+3; // length of hostname
000132  1ce8              ADDS     r0,r5,#3
000134  b2c1              UXTB     r1,r0
000136  1d28              ADDS     r0,r5,#4
000138  1a22              SUBS     r2,r4,r0
00013a  4838              LDR      r0,|L20.540|
00013c  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
00013e  30ec              ADDS     r0,r0,#0xec
000140  5481              STRB     r1,[r0,r2]
;;;386    
;;;387    	pDHCPMSG->OPT[k++] = dhcpParamRequest;
000142  2237              MOVS     r2,#0x37
000144  4620              MOV      r0,r4
000146  1c61              ADDS     r1,r4,#1
000148  b28c              UXTH     r4,r1
00014a  4934              LDR      r1,|L20.540|
00014c  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
00014e  31ec              ADDS     r1,r1,#0xec
000150  540a              STRB     r2,[r1,r0]
;;;388    	pDHCPMSG->OPT[k++] = 0x06;	// length of request
000152  2206              MOVS     r2,#6
000154  4620              MOV      r0,r4
000156  1c61              ADDS     r1,r4,#1
000158  b28c              UXTH     r4,r1
00015a  4930              LDR      r1,|L20.540|
00015c  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
00015e  31ec              ADDS     r1,r1,#0xec
000160  540a              STRB     r2,[r1,r0]
;;;389    	pDHCPMSG->OPT[k++] = subnetMask;
000162  2201              MOVS     r2,#1
000164  4620              MOV      r0,r4
000166  1c61              ADDS     r1,r4,#1
000168  b28c              UXTH     r4,r1
00016a  492c              LDR      r1,|L20.540|
00016c  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
00016e  31ec              ADDS     r1,r1,#0xec
000170  540a              STRB     r2,[r1,r0]
;;;390    	pDHCPMSG->OPT[k++] = routersOnSubnet;
000172  2203              MOVS     r2,#3
000174  4620              MOV      r0,r4
000176  1c61              ADDS     r1,r4,#1
000178  b28c              UXTH     r4,r1
00017a  4928              LDR      r1,|L20.540|
00017c  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
00017e  31ec              ADDS     r1,r1,#0xec
000180  540a              STRB     r2,[r1,r0]
;;;391    	pDHCPMSG->OPT[k++] = dns;
000182  2206              MOVS     r2,#6
000184  4620              MOV      r0,r4
000186  1c61              ADDS     r1,r4,#1
000188  b28c              UXTH     r4,r1
00018a  4924              LDR      r1,|L20.540|
00018c  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
00018e  31ec              ADDS     r1,r1,#0xec
000190  540a              STRB     r2,[r1,r0]
;;;392    	pDHCPMSG->OPT[k++] = domainName;
000192  220f              MOVS     r2,#0xf
000194  4620              MOV      r0,r4
000196  1c61              ADDS     r1,r4,#1
000198  b28c              UXTH     r4,r1
00019a  4920              LDR      r1,|L20.540|
00019c  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
00019e  31ec              ADDS     r1,r1,#0xec
0001a0  540a              STRB     r2,[r1,r0]
;;;393    	pDHCPMSG->OPT[k++] = dhcpT1value;
0001a2  223a              MOVS     r2,#0x3a
0001a4  4620              MOV      r0,r4
0001a6  1c61              ADDS     r1,r4,#1
0001a8  b28c              UXTH     r4,r1
0001aa  491c              LDR      r1,|L20.540|
0001ac  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
0001ae  31ec              ADDS     r1,r1,#0xec
0001b0  540a              STRB     r2,[r1,r0]
;;;394    	pDHCPMSG->OPT[k++] = dhcpT2value;
0001b2  223b              MOVS     r2,#0x3b
0001b4  4620              MOV      r0,r4
0001b6  1c61              ADDS     r1,r4,#1
0001b8  b28c              UXTH     r4,r1
0001ba  4918              LDR      r1,|L20.540|
0001bc  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
0001be  31ec              ADDS     r1,r1,#0xec
0001c0  540a              STRB     r2,[r1,r0]
;;;395    	pDHCPMSG->OPT[k++] = endOption;
0001c2  22ff              MOVS     r2,#0xff
0001c4  4620              MOV      r0,r4
0001c6  1c61              ADDS     r1,r4,#1
0001c8  b28c              UXTH     r4,r1
0001ca  4914              LDR      r1,|L20.540|
0001cc  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
0001ce  31ec              ADDS     r1,r1,#0xec
0001d0  540a              STRB     r2,[r1,r0]
;;;396    
;;;397    	for (i = k; i < OPT_SIZE; i++) pDHCPMSG->OPT[i] = 0;
0001d2  4625              MOV      r5,r4
0001d4  e006              B        |L20.484|
                  |L20.470|
0001d6  2100              MOVS     r1,#0
0001d8  4810              LDR      r0,|L20.540|
0001da  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
0001dc  30ec              ADDS     r0,r0,#0xec
0001de  5541              STRB     r1,[r0,r5]
0001e0  1c68              ADDS     r0,r5,#1
0001e2  b285              UXTH     r5,r0
                  |L20.484|
0001e4  f5b57f9c          CMP      r5,#0x138
0001e8  dbf5              BLT      |L20.470|
;;;398    
;;;399    	// send broadcasting packet
;;;400    	ip[0] = 255;
0001ea  20ff              MOVS     r0,#0xff
0001ec  f88d0004          STRB     r0,[sp,#4]
;;;401    	ip[1] = 255;
0001f0  f88d0005          STRB     r0,[sp,#5]
;;;402    	ip[2] = 255;
0001f4  f88d0006          STRB     r0,[sp,#6]
;;;403    	ip[3] = 255;
0001f8  f88d0007          STRB     r0,[sp,#7]
;;;404    
;;;405    #ifdef _DHCP_DEBUG_
;;;406    	printf("> Send DHCP_DISCOVER\r\n");
0001fc  a00a              ADR      r0,|L20.552|
0001fe  f7fffffe          BL       __2printf
;;;407    #endif
;;;408    
;;;409    	sendto(DHCP_SOCKET, (uint8_t *)pDHCPMSG, RIP_MSG_SIZE, ip, DHCP_SERVER_PORT);
000202  2043              MOVS     r0,#0x43
000204  ab01              ADD      r3,sp,#4
000206  f44f7209          MOV      r2,#0x224
00020a  9000              STR      r0,[sp,#0]
00020c  4803              LDR      r0,|L20.540|
00020e  6801              LDR      r1,[r0,#0]  ; pDHCPMSG
000210  480b              LDR      r0,|L20.576|
000212  7800              LDRB     r0,[r0,#0]  ; DHCP_SOCKET
000214  f7fffffe          BL       sendto
;;;410    }
000218  bd7c              POP      {r2-r6,pc}
;;;411    
                          ENDP

00021a  0000              DCW      0x0000
                  |L20.540|
                          DCD      pDHCPMSG
                  |L20.544|
                          DCD      DHCP_CHADDR
                  |L20.548|
                          DCD      HOST_NAME
                  |L20.552|
000228  3e205365          DCB      "> Send DHCP_DISCOVER\r\n",0
00022c  6e642044
000230  4843505f
000234  44495343
000238  4f564552
00023c  0d0a00  
00023f  00                DCB      0
                  |L20.576|
                          DCD      DHCP_SOCKET

                          AREA ||i.send_DHCP_REQUEST||, CODE, READONLY, ALIGN=2

                  send_DHCP_REQUEST PROC
;;;412    /* SEND DHCP REQUEST */
;;;413    void send_DHCP_REQUEST(void)
000000  b57c              PUSH     {r2-r6,lr}
;;;414    {
;;;415    	int i;
;;;416    	uint8_t ip[4];
;;;417    	uint16_t k = 0;
000002  2400              MOVS     r4,#0
;;;418    
;;;419       makeDHCPMSG();
000004  f7fffffe          BL       makeDHCPMSG
;;;420    
;;;421       if(dhcp_state == STATE_DHCP_LEASED || dhcp_state == STATE_DHCP_REREQUEST)
000008  48dc              LDR      r0,|L21.892|
00000a  7800              LDRB     r0,[r0,#0]  ; dhcp_state
00000c  2803              CMP      r0,#3
00000e  d003              BEQ      |L21.24|
000010  48da              LDR      r0,|L21.892|
000012  7800              LDRB     r0,[r0,#0]  ; dhcp_state
000014  2804              CMP      r0,#4
000016  d12c              BNE      |L21.114|
                  |L21.24|
;;;422       {
;;;423       	*((uint8_t*)(&pDHCPMSG->flags))   = ((DHCP_FLAGSUNICAST & 0xFF00)>> 8);
000018  2000              MOVS     r0,#0
00001a  49d9              LDR      r1,|L21.896|
00001c  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
00001e  7288              STRB     r0,[r1,#0xa]
;;;424       	*((uint8_t*)(&pDHCPMSG->flags)+1) = (DHCP_FLAGSUNICAST & 0x00FF);
000020  2100              MOVS     r1,#0
000022  48d7              LDR      r0,|L21.896|
000024  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
000026  72c1              STRB     r1,[r0,#0xb]
;;;425       	pDHCPMSG->ciaddr[0] = DHCP_allocated_ip[0];
000028  48d6              LDR      r0,|L21.900|
00002a  7800              LDRB     r0,[r0,#0]  ; DHCP_allocated_ip
00002c  49d4              LDR      r1,|L21.896|
00002e  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
000030  7308              STRB     r0,[r1,#0xc]
;;;426       	pDHCPMSG->ciaddr[1] = DHCP_allocated_ip[1];
000032  48d4              LDR      r0,|L21.900|
000034  7841              LDRB     r1,[r0,#1]  ; DHCP_allocated_ip
000036  48d2              LDR      r0,|L21.896|
000038  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
00003a  7341              STRB     r1,[r0,#0xd]
;;;427       	pDHCPMSG->ciaddr[2] = DHCP_allocated_ip[2];
00003c  48d1              LDR      r0,|L21.900|
00003e  7881              LDRB     r1,[r0,#2]  ; DHCP_allocated_ip
000040  48cf              LDR      r0,|L21.896|
000042  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
000044  7381              STRB     r1,[r0,#0xe]
;;;428       	pDHCPMSG->ciaddr[3] = DHCP_allocated_ip[3];
000046  48cf              LDR      r0,|L21.900|
000048  78c1              LDRB     r1,[r0,#3]  ; DHCP_allocated_ip
00004a  48cd              LDR      r0,|L21.896|
00004c  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
00004e  73c1              STRB     r1,[r0,#0xf]
;;;429       	ip[0] = DHCP_SIP[0];
000050  48cd              LDR      r0,|L21.904|
000052  7800              LDRB     r0,[r0,#0]  ; DHCP_SIP
000054  f88d0004          STRB     r0,[sp,#4]
;;;430       	ip[1] = DHCP_SIP[1];
000058  48cb              LDR      r0,|L21.904|
00005a  7840              LDRB     r0,[r0,#1]  ; DHCP_SIP
00005c  f88d0005          STRB     r0,[sp,#5]
;;;431       	ip[2] = DHCP_SIP[2];
000060  48c9              LDR      r0,|L21.904|
000062  7880              LDRB     r0,[r0,#2]  ; DHCP_SIP
000064  f88d0006          STRB     r0,[sp,#6]
;;;432       	ip[3] = DHCP_SIP[3];   	   	   	
000068  48c7              LDR      r0,|L21.904|
00006a  78c0              LDRB     r0,[r0,#3]  ; DHCP_SIP
00006c  f88d0007          STRB     r0,[sp,#7]
000070  e008              B        |L21.132|
                  |L21.114|
;;;433       }
;;;434       else
;;;435       {
;;;436       	ip[0] = 255;
000072  20ff              MOVS     r0,#0xff
000074  f88d0004          STRB     r0,[sp,#4]
;;;437       	ip[1] = 255;
000078  f88d0005          STRB     r0,[sp,#5]
;;;438       	ip[2] = 255;
00007c  f88d0006          STRB     r0,[sp,#6]
;;;439       	ip[3] = 255;   	   	   	
000080  f88d0007          STRB     r0,[sp,#7]
                  |L21.132|
;;;440       }
;;;441       
;;;442       k = 4;      // beacaue MAGIC_COOKIE already made by makeDHCPMSG()
000084  2404              MOVS     r4,#4
;;;443    	
;;;444    	// Option Request Param.
;;;445    	pDHCPMSG->OPT[k++] = dhcpMessageType;
000086  2235              MOVS     r2,#0x35
000088  4621              MOV      r1,r4
00008a  1c64              ADDS     r4,r4,#1
00008c  48bc              LDR      r0,|L21.896|
00008e  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
000090  30ec              ADDS     r0,r0,#0xec
000092  5442              STRB     r2,[r0,r1]
;;;446    	pDHCPMSG->OPT[k++] = 0x01;
000094  2201              MOVS     r2,#1
000096  4621              MOV      r1,r4
000098  1c64              ADDS     r4,r4,#1
00009a  48b9              LDR      r0,|L21.896|
00009c  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
00009e  30ec              ADDS     r0,r0,#0xec
0000a0  5442              STRB     r2,[r0,r1]
;;;447    	pDHCPMSG->OPT[k++] = DHCP_REQUEST;
0000a2  2203              MOVS     r2,#3
0000a4  4621              MOV      r1,r4
0000a6  1c64              ADDS     r4,r4,#1
0000a8  48b5              LDR      r0,|L21.896|
0000aa  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
0000ac  30ec              ADDS     r0,r0,#0xec
0000ae  5442              STRB     r2,[r0,r1]
;;;448    
;;;449    	pDHCPMSG->OPT[k++] = dhcpClientIdentifier;
0000b0  223d              MOVS     r2,#0x3d
0000b2  4621              MOV      r1,r4
0000b4  1c64              ADDS     r4,r4,#1
0000b6  48b2              LDR      r0,|L21.896|
0000b8  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
0000ba  30ec              ADDS     r0,r0,#0xec
0000bc  5442              STRB     r2,[r0,r1]
;;;450    	pDHCPMSG->OPT[k++] = 0x07;
0000be  2207              MOVS     r2,#7
0000c0  4621              MOV      r1,r4
0000c2  1c64              ADDS     r4,r4,#1
0000c4  48ae              LDR      r0,|L21.896|
0000c6  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
0000c8  30ec              ADDS     r0,r0,#0xec
0000ca  5442              STRB     r2,[r0,r1]
;;;451    	pDHCPMSG->OPT[k++] = 0x01;
0000cc  2201              MOVS     r2,#1
0000ce  4621              MOV      r1,r4
0000d0  1c64              ADDS     r4,r4,#1
0000d2  48ab              LDR      r0,|L21.896|
0000d4  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
0000d6  30ec              ADDS     r0,r0,#0xec
0000d8  5442              STRB     r2,[r0,r1]
;;;452    	pDHCPMSG->OPT[k++] = DHCP_CHADDR[0];
0000da  48ac              LDR      r0,|L21.908|
0000dc  7802              LDRB     r2,[r0,#0]  ; DHCP_CHADDR
0000de  4621              MOV      r1,r4
0000e0  1c64              ADDS     r4,r4,#1
0000e2  48a7              LDR      r0,|L21.896|
0000e4  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
0000e6  30ec              ADDS     r0,r0,#0xec
0000e8  5442              STRB     r2,[r0,r1]
;;;453    	pDHCPMSG->OPT[k++] = DHCP_CHADDR[1];
0000ea  48a8              LDR      r0,|L21.908|
0000ec  7842              LDRB     r2,[r0,#1]  ; DHCP_CHADDR
0000ee  4621              MOV      r1,r4
0000f0  1c64              ADDS     r4,r4,#1
0000f2  48a3              LDR      r0,|L21.896|
0000f4  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
0000f6  30ec              ADDS     r0,r0,#0xec
0000f8  5442              STRB     r2,[r0,r1]
;;;454    	pDHCPMSG->OPT[k++] = DHCP_CHADDR[2];
0000fa  48a4              LDR      r0,|L21.908|
0000fc  7882              LDRB     r2,[r0,#2]  ; DHCP_CHADDR
0000fe  4621              MOV      r1,r4
000100  1c64              ADDS     r4,r4,#1
000102  489f              LDR      r0,|L21.896|
000104  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
000106  30ec              ADDS     r0,r0,#0xec
000108  5442              STRB     r2,[r0,r1]
;;;455    	pDHCPMSG->OPT[k++] = DHCP_CHADDR[3];
00010a  48a0              LDR      r0,|L21.908|
00010c  78c2              LDRB     r2,[r0,#3]  ; DHCP_CHADDR
00010e  4621              MOV      r1,r4
000110  1c64              ADDS     r4,r4,#1
000112  489b              LDR      r0,|L21.896|
000114  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
000116  30ec              ADDS     r0,r0,#0xec
000118  5442              STRB     r2,[r0,r1]
;;;456    	pDHCPMSG->OPT[k++] = DHCP_CHADDR[4];
00011a  489c              LDR      r0,|L21.908|
00011c  7902              LDRB     r2,[r0,#4]  ; DHCP_CHADDR
00011e  4621              MOV      r1,r4
000120  1c64              ADDS     r4,r4,#1
000122  4897              LDR      r0,|L21.896|
000124  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
000126  30ec              ADDS     r0,r0,#0xec
000128  5442              STRB     r2,[r0,r1]
;;;457    	pDHCPMSG->OPT[k++] = DHCP_CHADDR[5];
00012a  4898              LDR      r0,|L21.908|
00012c  7942              LDRB     r2,[r0,#5]  ; DHCP_CHADDR
00012e  4621              MOV      r1,r4
000130  1c64              ADDS     r4,r4,#1
000132  4893              LDR      r0,|L21.896|
000134  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
000136  30ec              ADDS     r0,r0,#0xec
000138  5442              STRB     r2,[r0,r1]
;;;458    
;;;459       if(ip[3] == 255)  // if(dchp_state == STATE_DHCP_LEASED || dchp_state == DHCP_REREQUEST_STATE)
00013a  f89d0007          LDRB     r0,[sp,#7]
00013e  28ff              CMP      r0,#0xff
000140  d167              BNE      |L21.530|
;;;460       {
;;;461    		pDHCPMSG->OPT[k++] = dhcpRequestedIPaddr;
000142  2232              MOVS     r2,#0x32
000144  4620              MOV      r0,r4
000146  1c61              ADDS     r1,r4,#1
000148  b28c              UXTH     r4,r1
00014a  498d              LDR      r1,|L21.896|
00014c  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
00014e  31ec              ADDS     r1,r1,#0xec
000150  540a              STRB     r2,[r1,r0]
;;;462    		pDHCPMSG->OPT[k++] = 0x04;
000152  2204              MOVS     r2,#4
000154  4620              MOV      r0,r4
000156  1c61              ADDS     r1,r4,#1
000158  b28c              UXTH     r4,r1
00015a  4989              LDR      r1,|L21.896|
00015c  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
00015e  31ec              ADDS     r1,r1,#0xec
000160  540a              STRB     r2,[r1,r0]
;;;463    		pDHCPMSG->OPT[k++] = DHCP_allocated_ip[0];
000162  4888              LDR      r0,|L21.900|
000164  7802              LDRB     r2,[r0,#0]  ; DHCP_allocated_ip
000166  4620              MOV      r0,r4
000168  1c61              ADDS     r1,r4,#1
00016a  b28c              UXTH     r4,r1
00016c  4984              LDR      r1,|L21.896|
00016e  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
000170  31ec              ADDS     r1,r1,#0xec
000172  540a              STRB     r2,[r1,r0]
;;;464    		pDHCPMSG->OPT[k++] = DHCP_allocated_ip[1];
000174  4883              LDR      r0,|L21.900|
000176  7842              LDRB     r2,[r0,#1]  ; DHCP_allocated_ip
000178  4620              MOV      r0,r4
00017a  1c61              ADDS     r1,r4,#1
00017c  b28c              UXTH     r4,r1
00017e  4980              LDR      r1,|L21.896|
000180  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
000182  31ec              ADDS     r1,r1,#0xec
000184  540a              STRB     r2,[r1,r0]
;;;465    		pDHCPMSG->OPT[k++] = DHCP_allocated_ip[2];
000186  487f              LDR      r0,|L21.900|
000188  7882              LDRB     r2,[r0,#2]  ; DHCP_allocated_ip
00018a  4620              MOV      r0,r4
00018c  1c61              ADDS     r1,r4,#1
00018e  b28c              UXTH     r4,r1
000190  497b              LDR      r1,|L21.896|
000192  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
000194  31ec              ADDS     r1,r1,#0xec
000196  540a              STRB     r2,[r1,r0]
;;;466    		pDHCPMSG->OPT[k++] = DHCP_allocated_ip[3];
000198  487a              LDR      r0,|L21.900|
00019a  78c2              LDRB     r2,[r0,#3]  ; DHCP_allocated_ip
00019c  4620              MOV      r0,r4
00019e  1c61              ADDS     r1,r4,#1
0001a0  b28c              UXTH     r4,r1
0001a2  4977              LDR      r1,|L21.896|
0001a4  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
0001a6  31ec              ADDS     r1,r1,#0xec
0001a8  540a              STRB     r2,[r1,r0]
;;;467    	
;;;468    		pDHCPMSG->OPT[k++] = dhcpServerIdentifier;
0001aa  2236              MOVS     r2,#0x36
0001ac  4620              MOV      r0,r4
0001ae  1c61              ADDS     r1,r4,#1
0001b0  b28c              UXTH     r4,r1
0001b2  4973              LDR      r1,|L21.896|
0001b4  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
0001b6  31ec              ADDS     r1,r1,#0xec
0001b8  540a              STRB     r2,[r1,r0]
;;;469    		pDHCPMSG->OPT[k++] = 0x04;
0001ba  2204              MOVS     r2,#4
0001bc  4620              MOV      r0,r4
0001be  1c61              ADDS     r1,r4,#1
0001c0  b28c              UXTH     r4,r1
0001c2  496f              LDR      r1,|L21.896|
0001c4  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
0001c6  31ec              ADDS     r1,r1,#0xec
0001c8  540a              STRB     r2,[r1,r0]
;;;470    		pDHCPMSG->OPT[k++] = DHCP_SIP[0];
0001ca  486f              LDR      r0,|L21.904|
0001cc  7802              LDRB     r2,[r0,#0]  ; DHCP_SIP
0001ce  4620              MOV      r0,r4
0001d0  1c61              ADDS     r1,r4,#1
0001d2  b28c              UXTH     r4,r1
0001d4  496a              LDR      r1,|L21.896|
0001d6  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
0001d8  31ec              ADDS     r1,r1,#0xec
0001da  540a              STRB     r2,[r1,r0]
;;;471    		pDHCPMSG->OPT[k++] = DHCP_SIP[1];
0001dc  486a              LDR      r0,|L21.904|
0001de  7842              LDRB     r2,[r0,#1]  ; DHCP_SIP
0001e0  4620              MOV      r0,r4
0001e2  1c61              ADDS     r1,r4,#1
0001e4  b28c              UXTH     r4,r1
0001e6  4966              LDR      r1,|L21.896|
0001e8  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
0001ea  31ec              ADDS     r1,r1,#0xec
0001ec  540a              STRB     r2,[r1,r0]
;;;472    		pDHCPMSG->OPT[k++] = DHCP_SIP[2];
0001ee  4866              LDR      r0,|L21.904|
0001f0  7882              LDRB     r2,[r0,#2]  ; DHCP_SIP
0001f2  4620              MOV      r0,r4
0001f4  1c61              ADDS     r1,r4,#1
0001f6  b28c              UXTH     r4,r1
0001f8  4961              LDR      r1,|L21.896|
0001fa  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
0001fc  31ec              ADDS     r1,r1,#0xec
0001fe  540a              STRB     r2,[r1,r0]
;;;473    		pDHCPMSG->OPT[k++] = DHCP_SIP[3];
000200  4861              LDR      r0,|L21.904|
000202  78c2              LDRB     r2,[r0,#3]  ; DHCP_SIP
000204  4620              MOV      r0,r4
000206  1c61              ADDS     r1,r4,#1
000208  b28c              UXTH     r4,r1
00020a  495d              LDR      r1,|L21.896|
00020c  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
00020e  31ec              ADDS     r1,r1,#0xec
000210  540a              STRB     r2,[r1,r0]
                  |L21.530|
;;;474    	}
;;;475    
;;;476    	// host name
;;;477    	pDHCPMSG->OPT[k++] = hostName;
000212  220c              MOVS     r2,#0xc
000214  4620              MOV      r0,r4
000216  1c61              ADDS     r1,r4,#1
000218  b28c              UXTH     r4,r1
00021a  4959              LDR      r1,|L21.896|
00021c  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
00021e  31ec              ADDS     r1,r1,#0xec
000220  540a              STRB     r2,[r1,r0]
;;;478    	pDHCPMSG->OPT[k++] = 0; // length of hostname
000222  2200              MOVS     r2,#0
000224  4620              MOV      r0,r4
000226  1c61              ADDS     r1,r4,#1
000228  b28c              UXTH     r4,r1
00022a  4955              LDR      r1,|L21.896|
00022c  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
00022e  31ec              ADDS     r1,r1,#0xec
000230  540a              STRB     r2,[r1,r0]
;;;479    	for(i = 0 ; HOST_NAME[i] != 0; i++)
000232  2500              MOVS     r5,#0
000234  e009              B        |L21.586|
                  |L21.566|
;;;480       	pDHCPMSG->OPT[k++] = HOST_NAME[i];
000236  4856              LDR      r0,|L21.912|
000238  5d42              LDRB     r2,[r0,r5]
00023a  4620              MOV      r0,r4
00023c  1c61              ADDS     r1,r4,#1
00023e  b28c              UXTH     r4,r1
000240  494f              LDR      r1,|L21.896|
000242  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
000244  31ec              ADDS     r1,r1,#0xec
000246  540a              STRB     r2,[r1,r0]
000248  1c6d              ADDS     r5,r5,#1              ;479
                  |L21.586|
00024a  4851              LDR      r0,|L21.912|
00024c  5d40              LDRB     r0,[r0,r5]            ;479
00024e  2800              CMP      r0,#0                 ;479
000250  d1f1              BNE      |L21.566|
;;;481    	pDHCPMSG->OPT[k++] = DHCP_CHADDR[3];
000252  484e              LDR      r0,|L21.908|
000254  78c2              LDRB     r2,[r0,#3]  ; DHCP_CHADDR
000256  4620              MOV      r0,r4
000258  1c61              ADDS     r1,r4,#1
00025a  b28c              UXTH     r4,r1
00025c  4948              LDR      r1,|L21.896|
00025e  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
000260  31ec              ADDS     r1,r1,#0xec
000262  540a              STRB     r2,[r1,r0]
;;;482    	pDHCPMSG->OPT[k++] = DHCP_CHADDR[4];
000264  4849              LDR      r0,|L21.908|
000266  7902              LDRB     r2,[r0,#4]  ; DHCP_CHADDR
000268  4620              MOV      r0,r4
00026a  1c61              ADDS     r1,r4,#1
00026c  b28c              UXTH     r4,r1
00026e  4944              LDR      r1,|L21.896|
000270  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
000272  31ec              ADDS     r1,r1,#0xec
000274  540a              STRB     r2,[r1,r0]
;;;483    	pDHCPMSG->OPT[k++] = DHCP_CHADDR[5];
000276  4845              LDR      r0,|L21.908|
000278  7942              LDRB     r2,[r0,#5]  ; DHCP_CHADDR
00027a  4620              MOV      r0,r4
00027c  1c61              ADDS     r1,r4,#1
00027e  b28c              UXTH     r4,r1
000280  493f              LDR      r1,|L21.896|
000282  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
000284  31ec              ADDS     r1,r1,#0xec
000286  540a              STRB     r2,[r1,r0]
;;;484    	pDHCPMSG->OPT[k - (i+3+1)] = i+3; // length of hostname
000288  1ce8              ADDS     r0,r5,#3
00028a  b2c1              UXTB     r1,r0
00028c  1d28              ADDS     r0,r5,#4
00028e  1a22              SUBS     r2,r4,r0
000290  483b              LDR      r0,|L21.896|
000292  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
000294  30ec              ADDS     r0,r0,#0xec
000296  5481              STRB     r1,[r0,r2]
;;;485    	
;;;486    	pDHCPMSG->OPT[k++] = dhcpParamRequest;
000298  2237              MOVS     r2,#0x37
00029a  4620              MOV      r0,r4
00029c  1c61              ADDS     r1,r4,#1
00029e  b28c              UXTH     r4,r1
0002a0  4937              LDR      r1,|L21.896|
0002a2  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
0002a4  31ec              ADDS     r1,r1,#0xec
0002a6  540a              STRB     r2,[r1,r0]
;;;487    	pDHCPMSG->OPT[k++] = 0x08;
0002a8  2208              MOVS     r2,#8
0002aa  4620              MOV      r0,r4
0002ac  1c61              ADDS     r1,r4,#1
0002ae  b28c              UXTH     r4,r1
0002b0  4933              LDR      r1,|L21.896|
0002b2  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
0002b4  31ec              ADDS     r1,r1,#0xec
0002b6  540a              STRB     r2,[r1,r0]
;;;488    	pDHCPMSG->OPT[k++] = subnetMask;
0002b8  2201              MOVS     r2,#1
0002ba  4620              MOV      r0,r4
0002bc  1c61              ADDS     r1,r4,#1
0002be  b28c              UXTH     r4,r1
0002c0  492f              LDR      r1,|L21.896|
0002c2  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
0002c4  31ec              ADDS     r1,r1,#0xec
0002c6  540a              STRB     r2,[r1,r0]
;;;489    	pDHCPMSG->OPT[k++] = routersOnSubnet;
0002c8  2203              MOVS     r2,#3
0002ca  4620              MOV      r0,r4
0002cc  1c61              ADDS     r1,r4,#1
0002ce  b28c              UXTH     r4,r1
0002d0  492b              LDR      r1,|L21.896|
0002d2  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
0002d4  31ec              ADDS     r1,r1,#0xec
0002d6  540a              STRB     r2,[r1,r0]
;;;490    	pDHCPMSG->OPT[k++] = dns;
0002d8  2206              MOVS     r2,#6
0002da  4620              MOV      r0,r4
0002dc  1c61              ADDS     r1,r4,#1
0002de  b28c              UXTH     r4,r1
0002e0  4927              LDR      r1,|L21.896|
0002e2  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
0002e4  31ec              ADDS     r1,r1,#0xec
0002e6  540a              STRB     r2,[r1,r0]
;;;491    	pDHCPMSG->OPT[k++] = domainName;
0002e8  220f              MOVS     r2,#0xf
0002ea  4620              MOV      r0,r4
0002ec  1c61              ADDS     r1,r4,#1
0002ee  b28c              UXTH     r4,r1
0002f0  4923              LDR      r1,|L21.896|
0002f2  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
0002f4  31ec              ADDS     r1,r1,#0xec
0002f6  540a              STRB     r2,[r1,r0]
;;;492    	pDHCPMSG->OPT[k++] = dhcpT1value;
0002f8  223a              MOVS     r2,#0x3a
0002fa  4620              MOV      r0,r4
0002fc  1c61              ADDS     r1,r4,#1
0002fe  b28c              UXTH     r4,r1
000300  491f              LDR      r1,|L21.896|
000302  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
000304  31ec              ADDS     r1,r1,#0xec
000306  540a              STRB     r2,[r1,r0]
;;;493    	pDHCPMSG->OPT[k++] = dhcpT2value;
000308  223b              MOVS     r2,#0x3b
00030a  4620              MOV      r0,r4
00030c  1c61              ADDS     r1,r4,#1
00030e  b28c              UXTH     r4,r1
000310  491b              LDR      r1,|L21.896|
000312  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
000314  31ec              ADDS     r1,r1,#0xec
000316  540a              STRB     r2,[r1,r0]
;;;494    	pDHCPMSG->OPT[k++] = performRouterDiscovery;
000318  221f              MOVS     r2,#0x1f
00031a  4620              MOV      r0,r4
00031c  1c61              ADDS     r1,r4,#1
00031e  b28c              UXTH     r4,r1
000320  4917              LDR      r1,|L21.896|
000322  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
000324  31ec              ADDS     r1,r1,#0xec
000326  540a              STRB     r2,[r1,r0]
;;;495    	pDHCPMSG->OPT[k++] = staticRoute;
000328  2221              MOVS     r2,#0x21
00032a  4620              MOV      r0,r4
00032c  1c61              ADDS     r1,r4,#1
00032e  b28c              UXTH     r4,r1
000330  4913              LDR      r1,|L21.896|
000332  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
000334  31ec              ADDS     r1,r1,#0xec
000336  540a              STRB     r2,[r1,r0]
;;;496    	pDHCPMSG->OPT[k++] = endOption;
000338  22ff              MOVS     r2,#0xff
00033a  4620              MOV      r0,r4
00033c  1c61              ADDS     r1,r4,#1
00033e  b28c              UXTH     r4,r1
000340  490f              LDR      r1,|L21.896|
000342  6809              LDR      r1,[r1,#0]  ; pDHCPMSG
000344  31ec              ADDS     r1,r1,#0xec
000346  540a              STRB     r2,[r1,r0]
;;;497    
;;;498    	for (i = k; i < OPT_SIZE; i++) pDHCPMSG->OPT[i] = 0;
000348  4625              MOV      r5,r4
00034a  e005              B        |L21.856|
                  |L21.844|
00034c  2100              MOVS     r1,#0
00034e  480c              LDR      r0,|L21.896|
000350  6800              LDR      r0,[r0,#0]  ; pDHCPMSG
000352  30ec              ADDS     r0,r0,#0xec
000354  5541              STRB     r1,[r0,r5]
000356  1c6d              ADDS     r5,r5,#1
                  |L21.856|
000358  f5b57f9c          CMP      r5,#0x138
00035c  dbf6              BLT      |L21.844|
;;;499    
;;;500    #ifdef _DHCP_DEBUG_
;;;501    	printf("> Send DHCP_REQUEST\r\n");
00035e  a00d              ADR      r0,|L21.916|
000360  f7fffffe          BL       __2printf
;;;502    #endif
;;;503    	
;;;504    	sendto(DHCP_SOCKET, (uint8_t *)pDHCPMSG, RIP_MSG_SIZE, ip, DHCP_SERVER_PORT);
000364  2043              MOVS     r0,#0x43
000366  ab01              ADD      r3,sp,#4
000368  f44f7209          MOV      r2,#0x224
00036c  9000              STR      r0,[sp,#0]
00036e  4804              LDR      r0,|L21.896|
000370  6801              LDR      r1,[r0,#0]  ; pDHCPMSG
000372  480e              LDR      r0,|L21.940|
000374  7800              LDRB     r0,[r0,#0]  ; DHCP_SOCKET
000376  f7fffffe          BL       sendto
;;;505    
;;;506    }
00037a  bd7c              POP      {r2-r6,pc}
;;;507    
                          ENDP

                  |L21.892|
                          DCD      dhcp_state
                  |L21.896|
                          DCD      pDHCPMSG
                  |L21.900|
                          DCD      DHCP_allocated_ip
                  |L21.904|
                          DCD      DHCP_SIP
                  |L21.908|
                          DCD      DHCP_CHADDR
                  |L21.912|
                          DCD      HOST_NAME
                  |L21.916|
000394  3e205365          DCB      "> Send DHCP_REQUEST\r\n",0
000398  6e642044
00039c  4843505f
0003a0  52455155
0003a4  4553540d
0003a8  0a00    
0003aa  00                DCB      0
0003ab  00                DCB      0
                  |L21.940|
                          DCD      DHCP_SOCKET

                          AREA ||.data||, DATA, ALIGN=2

                  DHCP_SOCKET
000000  00                DCB      0x00
                  DHCP_SIP
000001  000000            DCB      0x00,0x00,0x00
000004  00                DCB      0x00
                  OLD_allocated_ip
000005  000000            DCB      0x00,0x00,0x00
000008  00                DCB      0x00
                  DHCP_allocated_ip
000009  000000            DCB      0x00,0x00,0x00
00000c  00                DCB      0x00
                  DHCP_allocated_gw
00000d  000000            DCB      0x00,0x00,0x00
000010  00                DCB      0x00
                  DHCP_allocated_sn
000011  000000            DCB      0x00,0x00,0x00
000014  00                DCB      0x00
                  DHCP_allocated_dns
000015  000000            DCB      0x00,0x00,0x00
000018  00                DCB      0x00
                  dhcp_state
000019  00                DCB      0x00
                  dhcp_retry_count
00001a  0000              DCB      0x00,0x00
                  dhcp_lease_time
                          DCD      0xffffffff
                  dhcp_tick_1s
                          DCD      0x00000000
                  dhcp_tick_next
                          DCD      0x0000000a
                  DHCP_XID
                          DCD      0x00000000
                  pDHCPMSG
                          DCD      0x00000000
                  HOST_NAME
000030  57495a6e          DCB      0x57,0x49,0x5a,0x6e
000034  65740000          DCB      0x65,0x74,0x00,0x00
                  DHCP_CHADDR
                          DCD      0x00000000
00003c  00000000          DCB      0x00,0x00,0x00,0x00
                  dhcp_ip_assign
                          DCD      default_ip_assign
                  dhcp_ip_update
                          DCD      default_ip_update
                  dhcp_ip_conflict
                          DCD      default_ip_conflict
